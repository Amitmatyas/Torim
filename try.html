<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torim</title>
    <link rel="icon" href="https://i.postimg.cc/mkLjSCzL/9.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css?family=Heebo:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0093e9;
            --primary-dark: #006bb3;
            --secondary: #f5f7fa;
            --background: #f3f6fc;
            --card: #fff;
            --shadow: 0 4px 24px 0 rgba(0,0,0,0.12);
            --radius: 18px;
            --accent: #ffd600;
            --danger: #e74c3c;
        }
        body {
            font-family: 'Heebo', Arial, sans-serif;
            background: linear-gradient(135deg, var(--secondary) 80%, var(--primary) 130%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: #222;
            letter-spacing: 0.01em;
        }
        header {
            width: 100%;
            background: var(--card);
            box-shadow: var(--shadow);
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }
        header img {
            max-height: 70px;
            margin: 16px 0;
            cursor: pointer;
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            animation: logoAnim 1.7s infinite alternate;
        }
        @keyframes logoAnim {
            0% { transform: scale(1) rotate(-7deg);}
            60% { transform: scale(1.04) rotate(6deg);}
            100% { transform: scale(1) rotate(-7deg);}
        }
        .header-spacer { width: 60px; }
        .header-actions {
            flex: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 20px;
        }
        .header-btn {
            background: none;
            border: none;
            color: var(--primary-dark);
            font-weight: 700;
            font-size: 1em;
            cursor: pointer;
            padding: 8px 15px 8px 15px;
            border-radius: 7px;
            transition: background 0.13s;
        }
        .header-btn:hover {
            background: #eaf6fd;
        }
        #loading {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255,255,255,0.94);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }
        #loading img {
            width: 110px;
            animation: loadingSpin 1.5s infinite linear;
        }
        @keyframes loadingSpin {
            0% { transform: rotate(-10deg);}
            100% { transform: rotate(350deg);}
        }
        .container {
            background: var(--card);
            margin: 36px auto 0 auto;
            box-shadow: var(--shadow);
            border-radius: var(--radius);
            width: min(460px, 97vw);
            padding: 32px 28px 28px 28px;
            position: relative;
            animation: fadeIn 1.2s;
        }
        @keyframes fadeIn {
            from {opacity: 0;transform: translateY(24px);}
            to {opacity: 1;transform: none;}
        }
        h1, h2 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 18px;
            margin-top: 0;
            font-weight: 800;
            letter-spacing: 0.05em;
        }
        h2 {
            font-size: 1.2em;
            margin-top: 30px;
            margin-bottom: 10px;
            color: var(--primary-dark);
        }
        label {
            font-weight: 600;
            margin-bottom: 6px;
            display: block;
        }
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="tel"],
        select {
            width: 100%;
            padding: 12px 10px;
            margin: 7px 0 18px 0;
            border: 1px solid #d0d7df;
            border-radius: 8px;
            box-sizing: border-box;
            background: #fafdff;
            font-size: 1em;
            transition: border-color .2s, box-shadow .2s;
        }
        input:focus, select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 2px 10px 0 rgba(0,147,233,0.09);
        }
        button {
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            color: #fff;
            font-size: 1.15em;
            font-weight: 600;
            padding: 14px 0;
            border: none;
            border-radius: 8px;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,147,233,0.11);
            cursor: pointer;
            margin-top: 6px;
            margin-bottom: 8px;
            letter-spacing: 0.04em;
            transition: background 0.2s, filter 0.18s;
        }
        button:hover, button:focus {
            filter: brightness(1.07);
            background: linear-gradient(90deg, var(--primary-dark), var(--primary));
        }
        .link-btn {
            background: none;
            color: var(--primary-dark);
            border: none;
            box-shadow: none;
            font-size: 1em;
            margin: 0;
            padding: 0;
            text-decoration: underline;
            cursor: pointer;
        }
        .error-message {
            background: #fff1f0;
            color: var(--danger);
            font-weight: 600;
            padding: 7px 13px;
            border-radius: 7px;
            margin-bottom: 12px;
            margin-top: -8px;
            font-size: 0.92em;
        }
        .success-message {
            background: #e3f7e1;
            color: #209a3c;
            font-weight: 600;
            padding: 7px 13px;
            border-radius: 7px;
            margin-bottom: 12px;
            margin-top: -8px;
            font-size: 0.92em;
        }
        #searchResults {
            margin-top: 18px;
        }
        .businessItem {
            border-radius: 11px;
            background: linear-gradient(90deg, #ecf5fd 70%, #fafdff 120%);
            box-shadow: 0 2px 7px rgba(0,147,233,0.07);
            border: 1.5px solid #eaf1fa;
            padding: 17px 13px;
            margin: 10px 0;
            cursor: pointer;
            transition: background 0.17s, box-shadow 0.18s;
            display: flex; flex-direction: column;
        }
        .businessItem:hover {
            background: #d1eaff;
            box-shadow: 0 4px 18px rgba(0,147,233,0.17);
        }
        .businessItem h3 {
            margin: 0 0 4px 0;
            font-size: 1.13em;
            color: var(--primary-dark);
        }
        .businessItem p {
            margin: 3px 0 0 0;
            color: #555;
            font-size: 0.95em;
        }
        /* יומן */
        #calendarContainer {
            direction: rtl;
            max-width: 390px;
            margin: 28px auto 0 auto;
            background: #fafdff;
            border-radius: 18px;
            box-shadow: 0 2px 10px rgba(0,147,233,0.08);
            padding: 20px 10px 15px 10px;
            border: 1px solid #e0e8f0;
            overflow-x: auto;
        }
        .calendar-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 6px;
            table-layout: fixed;
        }
        .calendar-table th, .calendar-table td {
            text-align: center;
            padding: 0;
            font-size: 1em;
        }
        .calendarDay {
            background: linear-gradient(120deg, #e7f3ff 70%, #fafdff 140%);
            border-radius: 8px;
            min-height: 54px;
            color: #007bff;
            border: 1.5px solid #d9e6f4;
            font-weight: 700;
            cursor: pointer;
            position: relative;
            transition: border-color 0.16s, background 0.17s, color 0.15s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 2px;
            min-width: 60px;
        }
        .calendarDay.selected, 
        .calendarDay:focus {
            background: linear-gradient(90deg, var(--primary) 60%, var(--primary-dark) 120%);
            color: #fff;
            border-color: var(--primary-dark);
            z-index: 2;
        }
        .calendarDay.disabled {
            background: #f8f8f8;
            color: #bbb;
            border-color: #eee;
            cursor: not-allowed;
            pointer-events: none;
        }
        .calendarDay .slot-list {
            margin-top: 3px;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: center;
        }
        .slot {
            background: #fff;
            border-radius: 6px;
            border: 1.2px solid #d0e1fa;
            color: var(--primary-dark);
            font-size: 0.96em;
            font-weight: 600;
            padding: 2px 7px;
            margin: 1.5px 0;
            cursor: pointer;
            transition: background 0.16s, color 0.15s, border-color 0.13s;
            box-shadow: 0 1px 6px rgba(0,147,233,0.10);
            white-space: nowrap;
        }
        .slot.selected, .slot:hover, .calendarDay.selected .slot.selected {
            background: var(--primary);
            color: #fff;
            border-color: var(--accent);
        }
        .slot[disabled] {
            background: #f2f2f2;
            color: #aaa;
            cursor: not-allowed;
        }
        /* כתובת עסק ממורכזת */
        #businessAddressLink {
            display: block;
            text-align: center;
            margin: 0 auto;
            font-size: 1.05em;
            color: var(--primary-dark);
            font-weight: 600;
            direction: ltr;
        }
        /* טופס התחברות/הרשמה מוקפץ */
        #authModal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 3000;
            background: rgba(33, 53, 70, 0.22);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s;
        }
        #authBox {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,147,233,0.16);
            padding: 32px 28px 28px 28px;
            min-width: 320px;
            max-width: 94vw;
            min-height: 320px;
        }
        #authTabs {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-bottom: 22px;
        }
        .auth-tab {
            flex: 1;
            padding: 12px 0;
            background: none;
            color: var(--primary-dark);
            border: none;
            border-bottom: 3px solid #e6eefa;
            font-size: 1.08em;
            font-weight: 700;
            cursor: pointer;
            transition: border-color 0.2s, color 0.17s;
        }
        .auth-tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            background: #fafdff;
        }
        #closeAuthModal {
            position: absolute;
            left: 25px;
            top: 20px;
            background: none;
            border: none;
            font-size: 1.5em;
            color: #888;
            cursor: pointer;
            z-index: 10;
        }
        /* עריכת חשבון */
        #accountModal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 3200;
            background: rgba(33, 53, 70, 0.22);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #accountBox {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,147,233,0.16);
            padding: 32px 28px 28px 28px;
            min-width: 320px;
            max-width: 94vw;
        }
        #logoutBtn {
            background: #eee;
            color: var(--danger);
            font-weight: 800;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            padding: 12px 0;
            margin-top: 22px;
            cursor: pointer;
            transition: background 0.16s;
        }
        #logoutBtn:hover { background: #ffeaea;}
        @media (max-width: 620px) {
            .container, #authBox, #accountBox {
                padding: 14px 2vw 14px 2vw;
                width: 99vw;
            }
            #calendarContainer {padding: 7px 1vw;}
        }
        @media (max-width: 430px) {
            #calendarContainer {max-width: 97vw;}
        }
    </style>
</head>
<body>
<!-- טעינה -->
<div id="loading">
    <img src="https://i.postimg.cc/mkLjSCzL/9.png" alt="טוען...">
</div>
<!-- סרגל עליון -->
<header>
    <span class="header-spacer"></span>
    <div class="header-logo">
        <img id="logoImg" src="https://i.postimg.cc/mkLjSCzL/9.png" alt="לוגו Torim">
    </div>
    <div class="header-actions">
        <button class="header-btn" id="editAccountBtn" style="display:none">עריכת חשבון</button>
        <button class="header-btn" id="openAuthBtn" style="display:none">התחברות/הרשמה</button>
    </div>
</header>
<!-- דיאלוג התחברות/הרשמה -->
<div id="authModal" style="display:none">
    <div id="authBox">
        <button id="closeAuthModal" title="סגור">&times;</button>
        <div id="authTabs">
            <button class="auth-tab active" id="loginTab">התחברות</button>
            <button class="auth-tab" id="registerTab">הרשמה</button>
        </div>
        <form id="loginForm">
            <label for="loginEmail">אימייל</label>
            <input type="email" id="loginEmail" placeholder="כתובת אימייל" autocomplete="username" required>
            <label for="loginPassword">סיסמה</label>
            <input type="password" id="loginPassword" placeholder="סיסמה" autocomplete="current-password" required>
            <button type="submit">התחבר</button>
            <div id="loginError" class="error-message" style="display: none;"></div>
        </form>
        <form id="registerForm" style="display: none;">
            <label for="registerFullName">שם מלא</label>
            <input type="text" id="registerFullName" placeholder="שם מלא" autocomplete="name" required>
            <label for="registerEmail">אימייל</label>
            <input type="email" id="registerEmail" placeholder="כתובת אימייל" autocomplete="email" required>
            <label for="registerPhone">מספר טלפון</label>
            <input type="tel" id="registerPhone" placeholder="מספר טלפון" autocomplete="tel" required>
            <label for="registerPassword">סיסמה</label>
            <input type="password" id="registerPassword" placeholder="סיסמה" autocomplete="new-password" required>
            <button type="submit">הרשם</button>
            <div id="registerError" class="error-message" style="display: none;"></div>
            <div id="registerSuccess" class="success-message" style="display: none;"></div>
        </form>
    </div>
</div>
<!-- דיאלוג עריכת חשבון -->
<div id="accountModal" style="display:none">
    <div id="accountBox">
        <h2>פרטי חשבון</h2>
        <form id="accountForm">
            <label for="accountFullName">שם מלא</label>
            <input type="text" id="accountFullName" required>
            <label for="accountPhone">מספר טלפון</label>
            <input type="tel" id="accountPhone" required>
            <label for="accountEmail">אימייל</label>
            <input type="email" id="accountEmail" disabled>
            <button type="submit">עדכן</button>
        </form>
        <button id="logoutBtn">התנתק</button>
        <div id="accountError" class="error-message" style="display: none;"></div>
        <div id="accountSuccess" class="success-message" style="display: none;"></div>
    </div>
</div>
<!-- החלקים הבאים זמינים רק לאחר התחברות -->
<div class="container" id="mainContainer" style="display: none;">
    <h1>חיפוש עסקים</h1>
    <input type="text" id="businessSearch" placeholder="חפש עסק, תחום, מילה, כתובת...">
    <button id="searchButton">חפש</button>
    <div id="searchResults"></div>
</div>
<div class="container" style="display: none;" id="businessDetails">
    <h1 id="businessName"></h1>
    <p><a id="businessAddressLink" href="#" target="_blank"></a></p>
    <div class="service-selection">
        <h2>בחר שירות</h2>
        <select id="serviceSelect">
            <option value="">בחר שירות...</option>
        </select>
    </div>
    <div class="team-member-selection" style="display: none;">
        <h2>בחר איש צוות</h2>
        <select id="teamMemberSelect">
            <option value="">בחר איש צוות...</option>
        </select>
    </div>
    <h2>בחר תאריך ושעה</h2>
    <div id="calendarContainer"></div>
    <button id="bookAppointmentButton" style="margin-top: 28px;">קבע תור</button>
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import { getFirestore, collection, query, where, getDocs, doc, getDoc, addDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyB9Yx45QdVZpk6qfscw-buJYnXxEYziQII",
        authDomain: "torim-titus.firebaseapp.com",
        projectId: "torim-titus",
        storageBucket: "torim-titus.firebasestorage.app",
        messagingSenderId: "38963060106",
        appId: "1:38963060106:web:b27223980b52d925be7c73",
        measurementId: "G-ZKYQS4CF6N"
    };
    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const auth = getAuth(app);
    // DOM Elements
    const loadingDiv = document.getElementById('loading');
    const authModal = document.getElementById('authModal');
    const authBox = document.getElementById('authBox');
    const closeAuthModal = document.getElementById('closeAuthModal');
    const openAuthBtn = document.getElementById('openAuthBtn');
    const editAccountBtn = document.getElementById('editAccountBtn');
    const accountModal = document.getElementById('accountModal');
    const logoutBtn = document.getElementById('logoutBtn');
    const accountForm = document.getElementById('accountForm');
    const accountFullName = document.getElementById('accountFullName');
    const accountPhone = document.getElementById('accountPhone');
    const accountEmail = document.getElementById('accountEmail');
    const accountError = document.getElementById('accountError');
    const accountSuccess = document.getElementById('accountSuccess');
    const mainContainer = document.getElementById('mainContainer');
    const businessSearchInput = document.getElementById('businessSearch');
    const searchButton = document.getElementById('searchButton');
    const searchResultsDiv = document.getElementById('searchResults');
    const businessDetailsDiv = document.getElementById('businessDetails');
    const businessNameH1 = document.getElementById('businessName');
    const businessAddressLink = document.getElementById('businessAddressLink');
    const serviceSelect = document.getElementById('serviceSelect');
    const teamMemberSelect = document.getElementById('teamMemberSelect');
    const calendarContainer = document.getElementById('calendarContainer');
    const bookAppointmentButton = document.getElementById('bookAppointmentButton');
    // Auth forms
    const loginTab = document.getElementById('loginTab');
    const registerTab = document.getElementById('registerTab');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const loginError = document.getElementById('loginError');
    const registerError = document.getElementById('registerError');
    const registerSuccess = document.getElementById('registerSuccess');
    // Logo
    const logoImg = document.getElementById('logoImg');
    // Global state
    let currentBusiness = null;
    let selectedDate = null;
    let selectedSlot = null;
    let selectedService = null;
    let selectedTeamMember = null;
    let userInfo = null;
    // Loading
    window.addEventListener('load', () => {
        setTimeout(() => {
            loadingDiv.style.opacity = "0";
            setTimeout(() => { loadingDiv.style.display = 'none'; }, 600);
        }, 900);
    });
    // --- Auth Tabs Switch ---
    loginTab.addEventListener('click', () => {
        loginTab.classList.add('active');
        registerTab.classList.remove('active');
        loginForm.style.display = '';
        registerForm.style.display = 'none';
    });
    registerTab.addEventListener('click', () => {
        loginTab.classList.remove('active');
        registerTab.classList.add('active');
        loginForm.style.display = 'none';
        registerForm.style.display = '';
    });
    // Open/close auth modal
    function showAuthModal() { authModal.style.display = "flex"; }
    function hideAuthModal() { authModal.style.display = "none"; }
    openAuthBtn.addEventListener('click', showAuthModal);
    closeAuthModal.addEventListener('click', hideAuthModal);
    // Logo click = home
    logoImg.addEventListener('click', () => {
        mainContainer.style.display = '';
        businessDetailsDiv.style.display = 'none';
    });
    // --- Firebase Auth Logic ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // Load user info
            userInfo = { uid: user.uid, email: user.email, displayName: user.displayName || '' };
            // Try get details from firestore (for phone & name)
            const docSnap = await getDoc(doc(db, "users", user.uid));
            if (docSnap.exists()) {
                const data = docSnap.data();
                userInfo.fullName = data.fullName || '';
                userInfo.phone = data.phone || '';
            }
            authModal.style.display = "none";
            openAuthBtn.style.display = "none";
            editAccountBtn.style.display = "";
            mainContainer.style.display = "";
        } else {
            mainContainer.style.display = "none";
            businessDetailsDiv.style.display = "none";
            openAuthBtn.style.display = "";
            editAccountBtn.style.display = "none";
            userInfo = null;
        }
    });
    // רישום
    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        registerError.style.display = 'none';
        registerSuccess.style.display = 'none';
        const fullName = document.getElementById('registerFullName').value.trim();
        const email = document.getElementById('registerEmail').value.trim().toLowerCase();
        const phone = document.getElementById('registerPhone').value.trim();
        const password = document.getElementById('registerPassword').value;
        if (!fullName || !email || !phone || !password) {
            registerError.textContent = "אנא מלא את כל השדות";
            registerError.style.display = '';
            return;
        }
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await updateProfile(userCredential.user, { displayName: fullName });
            await setDoc(doc(db, "users", userCredential.user.uid), { email, fullName, phone });
            registerSuccess.textContent = "נרשמת בהצלחה! אפשר להתחבר עכשיו";
            registerSuccess.style.display = '';
            registerForm.reset();
        } catch (err) {
            registerError.textContent = err.message.replace("Firebase:", "");
            registerError.style.display = '';
        }
    });
    // התחברות
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        loginError.style.display = 'none';
        const email = document.getElementById('loginEmail').value.trim().toLowerCase();
        const password = document.getElementById('loginPassword').value;
        if (!email || !password) {
            loginError.textContent = "יש למלא את כל השדות";
            loginError.style.display = '';
            return;
        }
        try {
            await signInWithEmailAndPassword(auth, email, password);
            loginForm.reset();
        } catch (err) {
            loginError.textContent = err.message.replace("Firebase:", "");
            loginError.style.display = '';
        }
    });
    // --- עריכת חשבון ---
    editAccountBtn.addEventListener('click', () => {
        if (!userInfo) return;
        accountFullName.value = userInfo.fullName || '';
        accountPhone.value = userInfo.phone || '';
        accountEmail.value = userInfo.email || '';
        accountError.style.display = "none";
        accountSuccess.style.display = "none";
        accountModal.style.display = "flex";
    });
    accountModal.addEventListener('click', (e) => {
        if (e.target === accountModal) accountModal.style.display = "none";
    });
    accountForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        accountError.style.display = "none";
        accountSuccess.style.display = "none";
        try {
            await updateDoc(doc(db, "users", auth.currentUser.uid), {
                fullName: accountFullName.value.trim(),
                phone: accountPhone.value.trim()
            });
            accountSuccess.textContent = "הפרטים עודכנו!";
            accountSuccess.style.display = '';
            userInfo.fullName = accountFullName.value.trim();
            userInfo.phone = accountPhone.value.trim();
        } catch (err) {
            accountError.textContent = "שגיאה בעדכון. נסה שוב.";
            accountError.style.display = '';
        }
    });
    logoutBtn.addEventListener('click', async () => {
        await signOut(auth);
        accountModal.style.display = "none";
        authModal.style.display = "flex";
    });
    // --- BUSINESS SEARCH (Much more flexible) ---
    searchButton.addEventListener('click', async () => {
        const searchTerm = businessSearchInput.value.trim();
        if (!searchTerm) {
            searchResultsDiv.innerHTML = '<p>אנא הזן מחרוזת כלשהי לחיפוש.</p>';
            return;
        }
        searchResultsDiv.innerHTML = '<p>מחפש עסקים...</p>';
        try {
            // Search any field: name/address/category/services (case-insensitive)
            const q = query(collection(db, "businesses"));
            const querySnapshot = await getDocs(q);
            const results = querySnapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(b => {
                    const term = searchTerm.toLowerCase();
                    return (
                        (b.name && b.name.toLowerCase().includes(term)) ||
                        (b.address && b.address.toLowerCase().includes(term)) ||
                        (b.category && b.category.toLowerCase().includes(term)) ||
                        (b.services && b.services.some(s => s.name.toLowerCase().includes(term)))
                    );
                });
            if (!results.length) {
                searchResultsDiv.innerHTML = '<p>לא נמצאו עסקים תואמים.</p>';
                return;
            }
            searchResultsDiv.innerHTML = '';
            results.forEach(business => {
                const businessItem = document.createElement('div');
                businessItem.className = 'businessItem';
                businessItem.dataset.businessId = business.id;
                businessItem.innerHTML = `<h3>${business.name}</h3><p>${business.address}</p>`;
                businessItem.addEventListener('click', () => selectBusiness(business.id, business));
                searchResultsDiv.appendChild(businessItem);
            });
        } catch (e) {
            console.error("Error searching businesses: ", e);
            searchResultsDiv.innerHTML = '<p>אירעה שגיאה בחיפוש עסקים.</p>';
        }
    });
    // --- בחירת עסק ---
    async function selectBusiness(businessId, businessData) {
        currentBusiness = { id: businessId, ...businessData };
        businessNameH1.textContent = currentBusiness.name;
        businessAddressLink.textContent = currentBusiness.address;
        businessAddressLink.href = currentBusiness.addressLink || "#";
        await loadServicesAndTeamMembers(currentBusiness.id);
        mainContainer.style.display = 'none';
        businessDetailsDiv.style.display = 'block';
    }
    // --- טעינת שירותים ואנשי צוות ---
    async function loadServicesAndTeamMembers(businessId) {
        try {
            const businessDocRef = doc(db, "businesses", businessId);
            const businessDocSnap = await getDoc(businessDocRef);
            if (businessDocSnap.exists()) {
                const data = businessDocSnap.data();
                // Services
                serviceSelect.innerHTML = '<option value="">בחר שירות...</option>';
                if (data.services && data.services.length > 0) {
                    data.services.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service.id;
                        option.textContent = `${service.name} (${service.price} ש"ח)`;
                        serviceSelect.appendChild(option);
                    });
                } else {
                    serviceSelect.innerHTML += '<option value="" disabled>אין שירותים זמינים</option>';
                }
                // Team members
                teamMemberSelect.innerHTML = '<option value="">בחר איש צוות...</option>';
                if (data.teamMembers && data.teamMembers.length > 0) {
                    data.teamMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = member.name;
                        teamMemberSelect.appendChild(option);
                    });
                } else {
                    teamMemberSelect.innerHTML += '<option value="" disabled>אין אנשי צוות זמינים</option>';
                }
            }
        } catch (e) {
            console.error("Error loading services and team members:", e);
        }
        calendarContainer.innerHTML = '';
    }
    serviceSelect.addEventListener('change', async () => {
        selectedService = serviceSelect.value;
        if (!selectedService) {
            teamMemberSelect.value = "";
            teamMemberSelect.parentElement.style.display = 'none';
            calendarContainer.innerHTML = '';
            return;
        }
        teamMemberSelect.parentElement.style.display = 'block';
        teamMemberSelect.innerHTML = '<option value="">בחר איש צוות...</option>';
        const businessDocRef = doc(db, "businesses", currentBusiness.id);
        const businessDocSnap = await getDoc(businessDocRef);
        if (businessDocSnap.exists()) {
            const data = businessDocSnap.data();
            const selectedServiceObj = data.services.find(s => s.id === selectedService);
            if (selectedServiceObj && selectedServiceObj.assignedTeamMembers && selectedServiceObj.assignedTeamMembers.length > 0) {
                const filteredTeamMembers = data.teamMembers.filter(member =>
                    selectedServiceObj.assignedTeamMembers.includes(member.id)
                );
                if (filteredTeamMembers.length > 0) {
                    filteredTeamMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = member.name;
                        teamMemberSelect.appendChild(option);
                    });
                } else {
                    teamMemberSelect.innerHTML += '<option value="" disabled>אין אנשי צוות מתאימים לשירות זה</option>';
                }
            } else if (data.teamMembers && data.teamMembers.length > 0) {
                data.teamMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    teamMemberSelect.appendChild(option);
                });
            }
        }
        calendarContainer.innerHTML = '';
    });
    // --- יומן חדש עם שעות על גבי היומן (לא בלחיצה) ---
    teamMemberSelect.addEventListener('change', () => {
        selectedTeamMember = teamMemberSelect.value;
        if (selectedService && selectedTeamMember) {
            generateCalendar(currentBusiness.id, selectedTeamMember, selectedService);
        } else {
            calendarContainer.innerHTML = '';
        }
    });
    async function generateCalendar(businessId, teamMemberId, serviceId) {
        calendarContainer.innerHTML = '<p>טוען יומן...</p>';
        try {
            const businessDocRef = doc(db, "businesses", businessId);
            const businessDocSnap = await getDoc(businessDocRef);
            if (!businessDocSnap.exists()) {
                calendarContainer.innerHTML = '<p>שגיאה בטעינת נתוני עסק.</p>';
                return;
            }
            const businessData = businessDocSnap.data();
            const businessWorkDays = businessData.workDays || []; // ימים שהעסק עובד בשמות ימים
            const businessOpenTime = businessData.openTime;
            const businessCloseTime = businessData.closeTime;
            const appointmentDuration = parseInt(businessData.appointmentDuration || 30);
            const breakDuration = parseInt(businessData.breakDuration || 0);
            const businessUnavailableDates = businessData.unavailableDates || [];
            const businessUnavailableHours = businessData.unavailableHours || [];
            // שליפת תורים קיימים
            const appointmentsQuery = query(
                collection(db, "appointments"),
                where("businessId", "==", businessId),
                where("teamMemberId", "==", teamMemberId)
            );
            const appointmentsSnapshot = await getDocs(appointmentsQuery);
            const existingAppointments = appointmentsSnapshot.docs.map(doc => doc.data());
            // בניית מערך תאריכים
            let daysArr = [];
            const today = new Date();
            today.setHours(0,0,0,0);
            // יום ראשון הוא 0, שבת 6
            const dayNames = ['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'];
            let dayNameToIdx = {};
            dayNames.forEach((n, i) => { dayNameToIdx[n]=i; });
            for (let i = 0; daysArr.length < 30 && i < 42; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dayOfWeek = date.getDay();
                const dayName = dayNames[dayOfWeek];
                // האם העסק עובד ביום הזה?
                if (!businessWorkDays.includes(dayName)) continue;
                // חסימות תאריכים
                const isDateBlocked = businessUnavailableDates.some(range => {
                    const start = new Date(range.startDate);
                    const end = new Date(range.endDate);
                    start.setHours(0,0,0,0);
                    end.setHours(0,0,0,0);
                    return date >= start && date <= end;
                });
                if (isDateBlocked) continue;
                daysArr.push({date, dayName, formatted: date.toISOString().split('T')[0]});
            }
            // יומן כטבלה
            calendarContainer.innerHTML = '';
            const table = document.createElement('table');
            table.className = 'calendar-table';
            // Header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            for (let i = 0; i < 7; i++) {
                const th = document.createElement('th');
                th.textContent = dayNames[i];
                headerRow.appendChild(th);
            }
            thead.appendChild(headerRow);
            table.appendChild(thead);
            // Body
            const tbody = document.createElement('tbody');
            let row = document.createElement('tr');
            // Placeholders for empty days at start
            let gridPos = daysArr[0].date.getDay();
            for (let i = 0; i < gridPos; i++) {
                const td = document.createElement('td');
                row.appendChild(td);
            }
            // Fill calendar
            daysArr.forEach((dayObj, idx) => {
                if ((gridPos + idx) % 7 === 0 && idx !== 0) {
                    tbody.appendChild(row);
                    row = document.createElement('tr');
                }
                const { date, dayName, formatted } = dayObj;
                const td = document.createElement('td');
                td.style.verticalAlign = "top";
                const cell = document.createElement('div');
                cell.className = 'calendarDay';
                cell.tabIndex = 0;
                cell.dataset.date = formatted;
                cell.innerHTML = `<div style="font-size:1.1em">${date.getDate()}</div>
                                  <div style="font-size:0.98em;color:#888">${dayName}</div>`;
                // שעות בתאריך (על גבי היומן)
                const slotList = document.createElement('div');
                slotList.className = 'slot-list';
                let openTime = businessOpenTime, closeTime = businessCloseTime;
                let currentTime = new Date(`${formatted}T${openTime}`);
                const endTime = new Date(`${formatted}T${closeTime}`);
                const businessUnavailableHoursForDate = businessUnavailableHours.filter(uh => uh.date === formatted);
                const dailyAppointments = existingAppointments.filter(app => app.date === formatted);
                let anySlot = false;
                while (currentTime < endTime) {
                    const slotEndTime = new Date(currentTime.getTime() + appointmentDuration * 60 * 1000);
                    if (slotEndTime > endTime) break;
                    const formattedSlot = currentTime.toTimeString().substring(0, 5); // HH:MM
                    let isSlotAvailable = true;
                    // התנגשות עם תורים
                    for (const app of dailyAppointments) {
                        const appStart = new Date(`${app.date}T${app.time}`);
                        const appEnd = new Date(appStart.getTime() + (parseInt(app.duration || appointmentDuration)) * 60 * 1000);
                        if (currentTime < appEnd && slotEndTime > appStart) {
                            isSlotAvailable = false;
                            break;
                        }
                    }
                    // התנגשות עם חסימות שעות
                    if (isSlotAvailable) {
                        for (const blocked of businessUnavailableHoursForDate) {
                            const blockedStart = new Date(`${formatted}T${blocked.startTime}`);
                            const blockedEnd = new Date(`${formatted}T${blocked.endTime}`);
                            if (currentTime < blockedEnd && slotEndTime > blockedStart) {
                                isSlotAvailable = false;
                                break;
                            }
                        }
                    }
                    if (isSlotAvailable) {
                        anySlot = true;
                        const slotElem = document.createElement('div');
                        slotElem.className = 'slot';
                        slotElem.dataset.time = formattedSlot;
                        slotElem.textContent = formattedSlot;
                        slotElem.addEventListener('click', (ev) => {
                            ev.stopPropagation();
                            document.querySelectorAll('.calendarDay').forEach(d => d.classList.remove('selected'));
                            document.querySelectorAll('.slot').forEach(s => s.classList.remove('selected'));
                            cell.classList.add('selected');
                            slotElem.classList.add('selected');
                            selectedDate = formatted;
                            selectedSlot = formattedSlot;
                        });
                        slotList.appendChild(slotElem);
                    }
                    currentTime = new Date(slotEndTime.getTime() + breakDuration * 60 * 1000);
                }
                if (!anySlot) {
                    const noSlotEl = document.createElement('span');
                    noSlotEl.textContent = 'אין שעות';
                    noSlotEl.style.color = "#bbb";
                    noSlotEl.style.fontSize = "0.94em";
                    slotList.appendChild(noSlotEl);
                }
                cell.appendChild(slotList);
                td.appendChild(cell);
                row.appendChild(td);
            });
            // Fill end-of-row blanks
            let filled = (gridPos + daysArr.length) % 7;
            if (filled !== 0) for (let i = filled; i < 7; i++) row.appendChild(document.createElement('td'));
            tbody.appendChild(row);
            table.appendChild(tbody);
            calendarContainer.appendChild(table);
        } catch (e) {
            console.error("Error generating calendar:", e);
            calendarContainer.innerHTML = '<p>שגיאה בטעינת יומן.</p>';
        }
    }
    // --- קביעת תור ---
    bookAppointmentButton.addEventListener('click', async () => {
        if (!currentBusiness || !selectedDate || !selectedSlot || !selectedService || !selectedTeamMember) {
            alert("אנא בחר עסק, שירות, איש צוות, תאריך ושעה לפני קביעת התור.");
            return;
        }
        if (!userInfo || !userInfo.fullName || !userInfo.email || !userInfo.phone) {
            alert("עליך להיות מחובר עם פרטי לקוח מלאים.");
            return;
        }
        const businessDocRef = doc(db, "businesses", currentBusiness.id);
        const businessDocSnap = await getDoc(businessDocRef);
        const businessData = businessDocSnap.data();
        const serviceDetails = businessData.services.find(s => s.id === selectedService);
        const appointmentDuration = serviceDetails ? serviceDetails.duration : (businessData.appointmentDuration || 30);
        try {
            await addDoc(collection(db, "appointments"), {
                businessId: currentBusiness.id,
                businessName: currentBusiness.name,
                serviceId: selectedService,
                serviceName: serviceDetails ? serviceDetails.name : 'שירות לא ידוע',
                teamMemberId: selectedTeamMember,
                teamMemberName: teamMemberSelect.options[teamMemberSelect.selectedIndex].text,
                date: selectedDate,
                time: selectedSlot,
                duration: appointmentDuration,
                customerName: userInfo.fullName,
                customerEmail: userInfo.email,
                customerPhone: userInfo.phone,
                userId: userInfo.uid,
                timestamp: new Date()
            });
            alert("התור נקבע בהצלחה!");
            selectedDate = selectedSlot = selectedService = selectedTeamMember = null;
            calendarContainer.innerHTML = '';
            serviceSelect.value = '';
            teamMemberSelect.value = '';
            teamMemberSelect.parentElement.style.display = 'none';
        } catch (e) {
            console.error("Error adding document: ", e);
            alert("אירעה שגיאה בקביעת התור. אנא נסה שוב.");
        }
    });
    // דיאלוג התחברות סגירה בלחיצה על רקע
    authModal.addEventListener('click', (e) => {
        if (e.target === authModal) authModal.style.display = "none";
    });
</script>
</body>
</html>
