<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torim</title>
    <!-- Favicon using your logo -->
    <link rel="icon" href="https://i.postimg.cc/mkLjSCzL/9.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for Brand Colors */
        :root {
            --primary-dark: #572490; /* סגול כהה/אינדיגו */
            --secondary-light: #4BC0C8; /* תכלת-טורקיז */
            --text-dark: #333;
            --text-light: #f4f4f4;
            --border-color: #ddd;
            --background-light: #f9f9f9;
            --background-grey: #eee;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --modal-bg: rgba(0, 0, 0, 0.7);
            --success-color: #28a745;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }

        body {
            font-family: 'Heebo', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-light);
            color: var(--text-dark);
            direction: rtl; /* Right-to-left for Hebrew */
        }

        a {
            text-decoration: none;
            color: var(--primary-dark);
        }

        a:hover {
            text-decoration: underline;
        }

        button {
            cursor: pointer;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        button:hover {
            transform: translateY(-1px);
        }

        button.primary {
            background-color: var(--primary-dark);
            color: var(--text-light);
        }

        button.primary:hover {
            background-color: #4a1d7a; /* Slightly darker primary */
        }

        button.secondary {
            background-color: var(--secondary-light);
            color: var(--text-dark);
        }

        button.secondary:hover {
            background-color: #3aa2a8; /* Slightly darker secondary */
        }

        button.danger {
            background-color: var(--danger-color);
            color: var(--text-light);
        }

        button.danger:hover {
            background-color: #c82333;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        input[type="time"],
        input[type="date"],
        textarea,
        select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        input[type="checkbox"] {
            margin-left: 5px;
            margin-top: 5px;
        }

        /* --- Loading Screen --- */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            text-align: center;
        }

        .loading-screen img {
            width: 150px;
            height: auto;
            margin-bottom: 20px;
            animation: pulse 1.5s infinite alternate;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        /* --- Auth Modals (Login/Register) --- */
        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 450px;
            text-align: center;
            position: relative;
            direction: rtl;
        }

        .modal-close-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: none;
            border: none;
            font-size: 1.5em;
            color: #888;
            cursor: pointer;
        }

        .modal-content h2 {
            color: var(--primary-dark);
            margin-bottom: 25px;
        }

        .modal-content form input {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
        }

        .modal-content button[type="submit"] {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            margin-top: 15px;
        }

        .switch-auth-mode {
            margin-top: 15px;
            font-size: 0.9em;
            color: #666;
        }

        .switch-auth-mode a {
            color: var(--primary-dark);
            cursor: pointer;
            font-weight: bold;
        }

        /* --- Admin Dashboard Layout --- */
        .admin-dashboard-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Side Menu */
        .side-menu {
            width: 250px;
            background-color: var(--primary-dark);
            color: var(--text-light);
            padding: 20px;
            box-shadow: 2px 0 5px var(--shadow-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .side-menu .logo {
            margin-bottom: 30px;
            text-align: center;
        }

        .side-menu .logo img {
            width: 100px;
            height: auto;
        }

        .side-menu nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        .side-menu nav ul li {
            margin-bottom: 10px;
        }

        .side-menu nav ul li a {
            display: block;
            padding: 12px 15px;
            color: var(--text-light);
            font-weight: 500;
            border-radius: 5px;
            transition: background-color 0.3s ease;
            text-align: right;
        }

        .side-menu nav ul li a:hover,
        .side-menu nav ul li a.active {
            background-color: var(--secondary-light);
            color: var(--primary-dark);
            text-decoration: none;
        }

        .side-menu .logout-btn-container {
            margin-top: auto; /* Pushes to the bottom */
            width: 100%;
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            background-color: var(--background-light);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .dashboard-header h1 {
            color: var(--primary-dark);
            margin: 0;
            font-size: 2em;
        }

        .welcome-message {
            font-size: 1.1em;
            color: #555;
        }

        /* --- Dashboard Insights --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px var(--shadow-light);
            text-align: center;
        }

        .stat-card h3 {
            color: var(--primary-dark);
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: var(--secondary-light);
        }

        /* --- Table Styling --- */
        .data-table-container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px var(--shadow-light);
            overflow-x: auto;
            margin-bottom: 30px;
        }

        .data-table-container h2 {
            color: var(--primary-dark);
            margin-top: 0;
            margin-bottom: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            text-align: right;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background-color: var(--primary-dark);
            color: var(--text-light);
            font-weight: 500;
            text-align: right;
        }

        .data-table tbody tr:hover {
            background-color: var(--background-grey);
        }

        .data-table .actions button {
            margin-right: 5px;
            padding: 8px 12px;
            font-size: 0.9em;
        }

        /* --- Forms --- */
        .form-section {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px var(--shadow-light);
            margin-bottom: 30px;
        }

        .form-section h2 {
            color: var(--primary-dark);
            margin-top: 0;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-group .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 5px;
        }

        .form-group .checkbox-group label {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            font-weight: normal;
        }

        .form-group .checkbox-group input {
            width: auto;
            margin-left: 5px;
            margin-bottom: 0;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* --- Specific Section Styling --- */

        /* Employee Management */
        .employee-details-card {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px var(--shadow-light);
            margin-bottom: 20px;
        }

        .employee-details-card h3 {
            color: var(--primary-dark);
            margin-top: 0;
            margin-bottom: 15px;
        }

        .employee-details-card p {
            margin-bottom: 8px;
        }

        .employee-service-assignment label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .employee-service-assignment .service-checkbox {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .employee-service-assignment .service-checkbox input {
            width: auto;
            margin-left: 10px;
            margin-bottom: 0;
        }

        .employee-availability-form label {
            margin-top: 10px;
        }

        .employee-availability-form .day-hours {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .employee-availability-form .day-hours input[type="time"] {
            width: 100px;
        }

        .employee-availability-form .day-hours input[type="checkbox"] {
            width: auto;
            margin-left: 5px;
        }
        .employee-availability-form .day-hours span {
            min-width: 50px; /* Align day names */
            text-align: right;
        }


        /* Services Management */
        .service-form .form-group label {
            display: inline-block; /* For inline elements like price/duration */
            width: 120px;
            text-align: left;
        }
        .service-form .form-group input {
            width: calc(100% - 130px);
            display: inline-block;
        }

        /* Appointments Management */
        .appointments-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .appointments-filters select, .appointments-filters input {
            width: auto;
            min-width: 150px;
            margin-bottom: 0;
        }

        /* Client Management */
        .client-history-list {
            list-style: none;
            padding: 0;
        }
        .client-history-list li {
            background-color: var(--background-grey);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            text-align: right;
        }

        /* Absences & Holidays */
        .absence-entry {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            background-color: var(--background-grey);
            padding: 10px;
            border-radius: 5px;
        }
        .absence-entry span {
            flex-grow: 1;
        }

        .absence-calendar {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-light);
            margin-top: 20px;
        }
        .absence-calendar h3 {
            text-align: center;
            color: var(--primary-dark);
        }
        .absence-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .absence-calendar-grid div {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.9em;
        }
        .absence-calendar-grid .day-header {
            background-color: var(--primary-dark);
            color: var(--text-light);
            font-weight: bold;
        }
        .absence-calendar-grid .day-number {
            font-weight: bold;
        }
        .absence-calendar-grid .has-absence {
            background-color: #ffda6a; /* Yellowish for absence */
        }
        .absence-calendar-grid .today {
            border: 2px solid var(--secondary-light);
        }

        /* Clock-in/Clock-out */
        .clock-in-section {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px var(--shadow-light);
            text-align: center;
            margin-top: 30px;
        }
        .clock-in-section h2 {
            color: var(--primary-dark);
        }
        .clock-status {
            font-size: 1.5em;
            font-weight: bold;
            margin: 20px 0;
            color: #555;
            animation: neon-pulse 1.5s infinite alternate;
        }
        .clock-status.in {
            color: var(--success-color);
            text-shadow: 0 0 5px var(--success-color);
        }
        .clock-status.out {
            color: var(--danger-color);
            text-shadow: 0 0 5px var(--danger-color);
        }

        @keyframes neon-pulse {
            0% { text-shadow: 0 0 5px currentColor, 0 0 10px currentColor; }
            100% { text-shadow: 0 0 10px currentColor, 0 0 20px currentColor; }
        }


        .clock-in-section .clock-btn {
            padding: 15px 30px;
            font-size: 1.3em;
            border-radius: 50px;
            margin: 0 10px;
        }

        #clockInTime, #clockOutTime {
            font-size: 1.1em;
            margin-top: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .admin-dashboard-layout {
                flex-direction: column;
            }
            .side-menu {
                width: 100%;
                height: auto;
                position: relative;
                padding: 15px;
                box-shadow: 0 2px 5px var(--shadow-light);
            }
            .side-menu nav ul {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
            .side-menu nav ul li {
                margin: 5px 10px;
            }
            .side-menu .logo {
                margin-bottom: 15px;
            }
            .side-menu .logout-btn-container {
                margin-top: 15px;
                border-top: none;
            }

            .main-content {
                padding: 20px 15px;
            }

            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 20px;
            }
            .dashboard-header h1 {
                margin-bottom: 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .data-table-container {
                padding: 15px;
            }

            .appointments-filters {
                flex-direction: column;
                align-items: stretch;
            }
            .appointments-filters select, .appointments-filters input {
                width: 100%;
            }

            .form-section {
                padding: 15px;
            }
            .form-group .checkbox-group {
                flex-direction: column;
            }
            .form-buttons {
                flex-direction: column;
            }
            .form-buttons button {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <img src="https://i.postimg.cc/mkLjSCzL/9.png" alt="לוגו המערכת">
        <p>טוען את לוח הבקרה...</p>
    </div>

    <!-- Login Modal - Always shown first if not authenticated -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal-content">
            <h2>התחברות למנהלים</h2>
            <form id="loginForm">
                <input type="email" id="loginEmail" placeholder="אימייל" required>
                <input type="password" id="loginPassword" placeholder="סיסמה" required>
                <button type="submit" class="primary">התחבר</button>
            </form>
            <div class="switch-auth-mode">
                אין לך חשבון? <a href="#" id="switchToRegister">הירשם כאן</a>
            </div>
        </div>
    </div>

    <!-- Register Modal - For new businesses / managers -->
    <div class="modal-overlay" id="registerModal">
        <div class="modal-content">
            <button class="modal-close-btn close-auth-modal">&times;</button>
            <h2>יצירת חשבון עסק</h2>
            <form id="registerForm">
                <input type="text" id="businessName" placeholder="שם העסק" required>
                <input type="text" id="businessType" placeholder="סוג העסק (לדוגמה: מספרה, מכון יופי)" required>
                <input type="text" id="businessAddress" placeholder="כתובת העסק" required>
                <input type="tel" id="businessPhone" placeholder="טלפון העסק" required>
                <textarea id="businessDescription" placeholder="תיאור קצר של העסק" rows="3"></textarea>
                <label for="businessLogoUpload">לוגו העסק:</label>
                <input type="file" id="businessLogoUpload" accept="image/*">
                <label for="businessImagesUpload">תמונות העסק:</label>
                <input type="file" id="businessImagesUpload" accept="image/*" multiple>

                <hr style="margin: 20px 0;">
                <h3>פרטי מנהל ראשי</h3>
                <input type="text" id="managerFullName" placeholder="שם מלא של המנהל" required>
                <input type="email" id="managerEmail" placeholder="אימייל מנהל (ישמש להתחברות)" required>
                <input type="password" id="managerPassword" placeholder="סיסמה (לפחות 6 תווים)" required>
                <input type="password" id="managerConfirmPassword" placeholder="אשר סיסמה" required>
                <button type="submit" class="primary">הירשם והקם עסק</button>
            </form>
            <div class="switch-auth-mode">
                יש לך כבר חשבון? <a href="#" id="switchToLogin">התחבר כאן</a>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Layout -->
    <div class="admin-dashboard-layout" id="adminDashboardLayout" style="display: none;">
        <!-- Side Menu -->
        <aside class="side-menu">
            <div class="logo">
                <img src="https://i.postimg.cc/mkLjSCzL/9.png" alt="לוגו המערכת">
            </div>
            <nav>
                <ul>
                    <li><a href="#" id="navDashboard" class="active">סקירה כללית</a></li>
                    <li><a href="#" id="navEmployees">עובדים</a></li>
                    <li><a href="#" id="navServices">שירותים</a></li>
                    <li><a href="#" id="navBusinessHours">שעות פעילות</a></li>
                    <li><a href="#" id="navAppointments">תורים</a></li>
                    <li><a href="#" id="navClients">לקוחות</a></li>
                    <li><a href="#" id="navAbsences">השבתות וחופשות</a></li>
                    <li><a href="#" id="navStats">סטטיסטיקות</a></li>
                    <li><a href="#" id="navClock">שעון נוכחות</a></li>
                </ul>
            </nav>
            <div class="logout-btn-container">
                <button class="danger" id="logoutBtn">התנתקות</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="dashboard-header">
                <h1 id="businessDashboardTitle"></h1>
                <p class="welcome-message" id="welcomeMessage"></p>
            </div>

            <!-- Dashboard Section -->
            <section id="dashboardSection" class="content-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>תורים קרובים</h3>
                        <div class="value" id="upcomingAppointmentsCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>הכנסות היום</h3>
                        <div class="value" id="dailyRevenue">0 ₪</div>
                    </div>
                    <div class="stat-card">
                        <h3>ביקורות חדשות</h3>
                        <div class="value" id="newReviewsCount">0</div>
                    </div>
                </div>
                <div class="data-table-container">
                    <h2>תורים להיום</h2>
                    <table class="data-table" id="todaysAppointmentsTable">
                        <thead>
                            <tr>
                                <th>שעה</th>
                                <th>לקוח</th>
                                <th>שירות</th>
                                <th>עובד</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Appointments will be loaded here -->
                        </tbody>
                    </table>
                    <p id="noTodaysAppointments" style="text-align: center; color: #888; display: none;">אין תורים להיום.</p>
                </div>
            </section>

            <!-- Employees Section -->
            <section id="employeesSection" class="content-section" style="display: none;">
                <div class="form-section">
                    <h2>הוספת עובד חדש</h2>
                    <form id="addEmployeeForm">
                        <div class="form-group">
                            <label for="employeeName">שם מלא:</label>
                            <input type="text" id="employeeName" required>
                        </div>
                        <div class="form-group">
                            <label for="employeeEmail">אימייל (לכניסה):</label>
                            <input type="email" id="employeeEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="employeePassword">סיסמה (לפחות 6 תווים):</label>
                            <input type="password" id="employeePassword" required>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="primary">הוסף עובד</button>
                        </div>
                    </form>
                </div>
                <div class="data-table-container">
                    <h2>רשימת עובדים</h2>
                    <table class="data-table" id="employeesTable">
                        <thead>
                            <tr>
                                <th>שם</th>
                                <th>אימייל</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Employees will be loaded here -->
                        </tbody>
                    </table>
                    <p id="noEmployees" style="text-align: center; color: #888; display: none;">אין עובדים רשומים.</p>
                </div>
                <!-- Employee Details Modal -->
                <div class="modal-overlay" id="employeeDetailsModal">
                    <div class="modal-content">
                        <button class="modal-close-btn close-employee-modal">&times;</button>
                        <h2 id="employeeDetailName"></h2>
                        <div class="employee-details-card">
                            <h3>פרטי עובד</h3>
                            <p><strong>אימייל:</strong> <span id="employeeDetailEmail"></span></p>
                            <!-- Add more employee details here if needed -->
                        </div>

                        <div class="form-section employee-service-assignment">
                            <h3>שירותים שמבוצעים על ידי עובד זה</h3>
                            <div id="employeeServicesCheckboxes" class="checkbox-group">
                                <!-- Services will be loaded here -->
                            </div>
                            <button class="primary" id="saveEmployeeServices">שמור שירותים</button>
                        </div>

                        <div class="form-section employee-availability-form">
                            <h3>ניהול זמינות אישית</h3>
                            <p style="font-size:0.9em; color:#777;">שעות אלה ידרסו את שעות העסק הרגילות עבור עובד זה.</p>
                            <form id="employeeAvailabilityForm">
                                <!-- Day hours will be loaded here -->
                            </form>
                            <button class="primary" id="saveEmployeeAvailability">שמור זמינות</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Services Section -->
            <section id="servicesSection" class="content-section" style="display: none;">
                <div class="form-section service-form">
                    <h2>הוספת שירות חדש</h2>
                    <form id="addServiceForm">
                        <div class="form-group">
                            <label for="serviceName">שם השירות:</label>
                            <input type="text" id="serviceName" required>
                        </div>
                        <div class="form-group">
                            <label for="serviceDescription">תיאור:</label>
                            <textarea id="serviceDescription" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="servicePrice">מחיר (₪):</label>
                            <input type="number" id="servicePrice" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="serviceDuration">משך זמן (דקות):</label>
                            <input type="number" id="serviceDuration" min="1" required>
                        </div>
                        <div class="form-group">
                            <label>עובדים המבצעים שירות זה:</label>
                            <div id="serviceEmployeesCheckboxes" class="checkbox-group">
                                <!-- Employees will be loaded here -->
                            </div>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="primary">הוסף שירות</button>
                        </div>
                    </form>
                </div>
                <div class="data-table-container">
                    <h2>רשימת שירותים</h2>
                    <table class="data-table" id="servicesTable">
                        <thead>
                            <tr>
                                <th>שם</th>
                                <th>מחיר (₪)</th>
                                <th>משך (דק')</th>
                                <th>מבוצע ע"י</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Services will be loaded here -->
                        </tbody>
                    </table>
                    <p id="noServices" style="text-align: center; color: #888; display: none;">אין שירותים מוגדרים.</p>
                </div>
            </section>

            <!-- Business Hours Section -->
            <section id="businessHoursSection" class="content-section" style="display: none;">
                <div class="form-section">
                    <h2>שעות פעילות קבועות לעסק</h2>
                    <p style="font-size:0.9em; color:#777;">שעות אלה יחולו על כל העובדים, אלא אם הוגדרה זמינות אישית לעובד ספציפי.</p>
                    <form id="businessHoursForm">
                        <div class="form-group">
                            <label for="defaultAppointmentDuration">משך תור ברירת מחדל (דקות):</label>
                            <input type="number" id="defaultAppointmentDuration" min="10" value="30" required>
                        </div>
                        <div class="form-group">
                            <label for="timeBetweenAppointments">זמן הספקה בין תורים (דקות):</label>
                            <input type="number" id="timeBetweenAppointments" min="0" value="0" required>
                        </div>
                        <!-- Breaks mechanism requires more complex UI/logic, added conceptually here -->
                        <div class="form-group">
                            <label for="breakFrequency">הפסקות קבועות:</label>
                            <input type="number" id="breakFrequency" min="0" value="0" placeholder="כל X תורים" style="width: calc(50% - 5px); display: inline-block;">
                            <input type="number" id="breakDuration" min="0" value="0" placeholder="משך הפסקה (דקות)" style="width: calc(50% - 5px); display: inline-block; margin-right: 10px;">
                            <p style="font-size:0.85em; color:#999; margin-top:5px;">(לדוגמה: כל 3 תורים, הפסקה של 10 דקות)</p>
                        </div>

                        <div id="dailyBusinessHours">
                            <!-- Daily hours will be loaded here -->
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="primary">שמור שעות פעילות</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Appointments Section -->
            <section id="appointmentsSection" class="content-section" style="display: none;">
                <div class="form-section">
                    <h2>ניהול תורים</h2>
                    <div class="appointments-filters">
                        <select id="appointmentFilterEmployee">
                            <option value="">כל העובדים</option>
                            <!-- Employees will be loaded -->
                        </select>
                        <select id="appointmentFilterService">
                            <option value="">כל השירותים</option>
                            <!-- Services will be loaded -->
                        </select>
                        <input type="date" id="appointmentFilterDate">
                        <button class="primary" id="filterAppointmentsBtn">סנן</button>
                    </div>
                    <div class="data-table-container">
                        <table class="data-table" id="appointmentsTable">
                            <thead>
                                <tr>
                                    <th>לקוח</th>
                                    <th>אימייל לקוח</th>
                                    <th>שירות</th>
                                    <th>עובד</th>
                                    <th>תאריך</th>
                                    <th>שעה</th>
                                    <th>סטטוס</th>
                                    <th>פעולות</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Appointments will be loaded here -->
                            </tbody>
                        </table>
                        <p id="noAppointments" style="text-align: center; color: #888; display: none;">לא נמצאו תורים.</p>
                    </div>
                </div>
            </section>

            <!-- Clients Section -->
            <section id="clientsSection" class="content-section" style="display: none;">
                <div class="form-section">
                    <h2>רשימת לקוחות</h2>
                    <input type="text" id="clientSearchInput" placeholder="חפש לקוח לפי שם או אימייל...">
                    <div class="data-table-container">
                        <table class="data-table" id="clientsTable">
                            <thead>
                                <tr>
                                    <th>שם</th>
                                    <th>אימייל</th>
                                    <th>טלפון</th>
                                    <th>מס' תורים</th>
                                    <th>פעולות</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Clients will be loaded here -->
                            </tbody>
                        </table>
                        <p id="noClients" style="text-align: center; color: #888; display: none;">אין לקוחות רשומים.</p>
                    </div>
                </div>
                <!-- Client Details Modal -->
                <div class="modal-overlay" id="clientDetailsModal">
                    <div class="modal-content">
                        <button class="modal-close-btn close-client-modal">&times;</button>
                        <h2 id="clientDetailName"></h2>
                        <div class="employee-details-card">
                            <h3>פרטי לקוח</h3>
                            <p><strong>אימייל:</strong> <span id="clientDetailEmail"></span></p>
                            <p><strong>טלפון:</strong> <span id="clientDetailPhone"></span></p>
                            <!-- Add more client details here if needed -->
                        </div>
                        <div class="data-table-container">
                            <h3>היסטוריית תורים</h3>
                            <ul class="client-history-list" id="clientAppointmentsHistory">
                                <!-- Client's past appointments will be listed here -->
                            </ul>
                            <p id="noClientAppointments" style="text-align: center; color: #888; display: none;">ללקוח זה אין היסטוריית תורים.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Absences Section -->
            <section id="absencesSection" class="content-section" style="display: none;">
                <div class="form-section">
                    <h2>השבתות וחופשות</h2>
                    <p style="font-size:0.9em; color:#777;">השבתות כלל העסק יחסמו תורים לכל העובדים. בקשות חופשה של עובדים ימתינו לאישור.</p>
                    <h3>השבתות כלל העסק</h3>
                    <form id="addBusinessAbsenceForm">
                        <div class="form-group">
                            <label for="businessAbsenceReason">סיבה:</label>
                            <input type="text" id="businessAbsenceReason" placeholder="חג, אירוע מיוחד, שיפוצים..." required>
                        </div>
                        <div class="form-group">
                            <label for="businessAbsenceStartDate">תאריך התחלה:</label>
                            <input type="date" id="businessAbsenceStartDate" required>
                        </div>
                        <div class="form-group">
                            <label for="businessAbsenceEndDate">תאריך סיום:</label>
                            <input type="date" id="businessAbsenceEndDate" required>
                        </div>
                        <button type="submit" class="primary">הוסף השבתה</button>
                    </form>

                    <h3 style="margin-top: 30px;">בקשות חופשה של עובדים</h3>
                    <div id="employeeAbsenceRequests">
                        <p id="noAbsenceRequests" style="text-align: center; color: #888; display: none;">אין בקשות חופשה חדשות.</p>
                        <!-- Employee absence requests will be loaded here -->
                    </div>

                    <h3 style="margin-top: 30px;">יומן חופשות מאושרות</h3>
                    <div class="absence-calendar" id="approvedAbsencesCalendar">
                        <!-- Calendar will be generated here -->
                    </div>
                </div>
            </section>

            <!-- Statistics Section -->
            <section id="statsSection" class="content-section" style="display: none;">
                <div class="form-section">
                    <h2>סטטיסטיקות ודוחות</h2>
                    <p style="color:#777;">(נדרש שילוב ספריית גרפים, לדוגמה: Chart.js)</p>

                    <h3>הכנסות לפי טווח תאריכים</h3>
                    <div class="form-group" style="display: flex; gap: 10px;">
                        <input type="date" id="statsStartDate" style="width:50%;">
                        <input type="date" id="statsEndDate" style="width:50%;">
                    </div>
                    <button class="primary" id="generateStatsBtn">הצג דוח</button>
                    <div id="revenueChartContainer" style="margin-top: 20px;">
                        <!-- Chart will be rendered here -->
                        <canvas id="revenueChart"></canvas>
                        <p id="totalRevenueDisplay" style="text-align: center; font-size: 1.2em; font-weight: bold; margin-top: 15px;"></p>
                    </div>

                    <h3 style="margin-top: 30px;">תפוסת עובדים</h3>
                    <div id="employeeOccupancyChartContainer">
                        <canvas id="employeeOccupancyChart"></canvas>
                    </div>

                    <h3 style="margin-top: 30px;">שירותים פופולריים</h3>
                    <div id="popularServicesChartContainer">
                        <canvas id="popularServicesChart"></canvas>
                    </div>

                    <h3 style="margin-top: 30px;">שעות שיא (קביעת תורים)</h3>
                    <div id="peakHoursChartContainer">
                        <canvas id="peakHoursChart"></canvas>
                    </div>

                    <h3 style="margin-top: 30px;">סיכום ביקורות</h3>
                    <div id="reviewsSummaryChartContainer">
                        <canvas id="reviewsSummaryChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Clock-in/Clock-out Section -->
            <section id="clockSection" class="content-section" style="display: none;">
                <div class="form-section clock-in-section">
                    <h2>שעון נוכחות - <span id="employeeClockName"></span></h2>
                    <p class="clock-status" id="clockStatus">העובד לא מחובר</p>
                    <button class="primary clock-btn" id="clockInBtn" style="display: none;">כניסה</button>
                    <button class="danger clock-btn" id="clockOutBtn" style="display: none;">יציאה</button>
                    <p id="clockInTime" style="display: none;">שעת כניסה: </p>
                    <p id="clockOutTime" style="display: none;">שעת יציאה: </p>

                    <h3 style="margin-top: 30px;">התור הבא שלי:</h3>
                    <div id="nextAppointmentDisplay">
                        <p style="color:#888;">אין תור קרוב.</p>
                    </div>

                    <h3 style="margin-top: 30px;">כל התורים שלי:</h3>
                    <div class="data-table-container">
                        <table class="data-table" id="myAppointmentsEmployeeTable">
                            <thead>
                                <tr>
                                    <th>תאריך</th>
                                    <th>שעה</th>
                                    <th>לקוח</th>
                                    <th>שירות</th>
                                    <th>סטטוס</th>
                                    <th>פעולות</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Employee's appointments will be loaded here -->
                            </tbody>
                        </table>
                        <p id="noEmployeeAppointments" style="text-align: center; color: #888; display: none;">אין תורים קבועים לך.</p>
                    </div>

                    <h3 style="margin-top: 30px;">בקשות חופשה (דורש אישור מנהל)</h3>
                    <form id="requestAbsenceForm">
                        <div class="form-group">
                            <label>סוג חופשה:</label>
                            <input type="radio" name="absenceType" value="fullDay" checked> יום שלם
                            <input type="radio" name="absenceType" value="specificHours"> שעות ספציפיות
                        </div>
                        <div class="form-group">
                            <label for="absenceDate">תאריך:</label>
                            <input type="date" id="absenceDate" required>
                        </div>
                        <div id="specificHoursFields" style="display: none;">
                            <div class="form-group">
                                <label for="absenceStartTime">משעה:</label>
                                <input type="time" id="absenceStartTime">
                            </div>
                            <div class="form-group">
                                <label for="absenceEndTime">עד שעה:</label>
                                <input type="time" id="absenceEndTime">
                            </div>
                        </div>
                        <button type="submit" class="primary">שלח בקשת חופשה</button>
                    </form>
                    <div id="pendingAbsenceRequests">
                        <h4 style="margin-top: 20px;">בקשות ממתינות/מאושרות:</h4>
                        <p id="noPendingAbsences" style="text-align: center; color: #888; display: none;">אין בקשות חופשה ממתינות/מאושרות.</p>
                        <!-- Pending/Approved absences will be listed here -->
                    </div>

                    <h3 style="margin-top: 30px;">בלת"מים / עדכונים בזמן אמת</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                        <button class="secondary" id="longBreakBtn">הפסקה ארוכה</button>
                        <button class="danger" id="urgentExitBtn">יציאה דחופה</button>
                        <button class="primary" id="addWalkInAppointmentBtn">קבלת תור נוסף (Walk-in)</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase SDKs - MUST be loaded before your custom script -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
    <!-- Optional: For Chart.js for statistics (add this if you want charts) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>


    <script type="text/javascript">
        // Firebase Configuration (from your provided snippet)
        const firebaseConfig = {
            apiKey: "AIzaSyB9Yx45QdVZpk6qfscw-buJYnXxEYziQII",
            authDomain: "torim-titus.firebaseapp.com",
            projectId: "torim-titus",
            storageBucket: "torim-titus.firebasestorage.app",
            messagingSenderId: "38963060106",
            appId: "1:38963060106:web:758f9499941c3078be7c73",
            measurementId: "G-ENR1E8JXN7"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const analytics = firebase.analytics(); // eslint-disable-line no-unused-vars
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Global Variables
        let currentBusinessId = null;
        let currentManagerUser = null; // Stores Firebase Auth user object for the manager
        let currentBusinessData = null; // Stores the business document data
        let currentEmployeeData = null; // Stores data if the logged-in user is an employee

        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const loginModal = document.getElementById('loginModal');
        const registerModal = document.getElementById('registerModal');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const switchToRegister = document.getElementById('switchToRegister');
        const switchToLogin = document.getElementById('switchToLogin');

        const adminDashboardLayout = document.getElementById('adminDashboardLayout');
        const businessDashboardTitle = document.getElementById('businessDashboardTitle');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const logoutBtn = document.getElementById('logoutBtn');

        // Navigation links
        const navDashboard = document.getElementById('navDashboard');
        const navEmployees = document.getElementById('navEmployees');
        const navServices = document.getElementById('navServices');
        const navBusinessHours = document.getElementById('navBusinessHours');
        const navAppointments = document.getElementById('navAppointments');
        const navClients = document.getElementById('navClients');
        const navAbsences = document.getElementById('navAbsences');
        const navStats = document.getElementById('navStats');
        const navClock = document.getElementById('navClock');

        // Content Sections
        const dashboardSection = document.getElementById('dashboardSection');
        const employeesSection = document.getElementById('employeesSection');
        const servicesSection = document.getElementById('servicesSection');
        const businessHoursSection = document.getElementById('businessHoursSection');
        const appointmentsSection = document.getElementById('appointmentsSection');
        const clientsSection = document.getElementById('clientsSection');
        const absencesSection = document.getElementById('absencesSection');
        const statsSection = document.getElementById('statsSection');
        const clockSection = document.getElementById('clockSection');

        // Dashboard elements
        const upcomingAppointmentsCount = document.getElementById('upcomingAppointmentsCount');
        const dailyRevenue = document.getElementById('dailyRevenue');
        const newReviewsCount = document.getElementById('newReviewsCount');
        const todaysAppointmentsTable = document.getElementById('todaysAppointmentsTable').querySelector('tbody');
        const noTodaysAppointments = document.getElementById('noTodaysAppointments');

        // Employee section
        const addEmployeeForm = document.getElementById('addEmployeeForm');
        const employeesTable = document.getElementById('employeesTable').querySelector('tbody');
        const noEmployees = document.getElementById('noEmployees');
        const employeeDetailsModal = document.getElementById('employeeDetailsModal');
        const employeeDetailName = document.getElementById('employeeDetailName');
        const employeeDetailEmail = document.getElementById('employeeDetailEmail');
        const employeeServicesCheckboxes = document.getElementById('employeeServicesCheckboxes');
        const saveEmployeeServices = document.getElementById('saveEmployeeServices');
        const employeeAvailabilityForm = document.getElementById('employeeAvailabilityForm');
        const saveEmployeeAvailability = document.getElementById('saveEmployeeAvailability');
        let currentEmployeeIdForDetails = null; // To store employee ID when modal is open

        // Services section
        const addServiceForm = document.getElementById('addServiceForm');
        const servicesTable = document.getElementById('servicesTable').querySelector('tbody');
        const noServices = document.getElementById('noServices');
        const serviceEmployeesCheckboxes = document.getElementById('serviceEmployeesCheckboxes');

        // Business Hours section
        const businessHoursForm = document.getElementById('businessHoursForm');
        const defaultAppointmentDuration = document.getElementById('defaultAppointmentDuration');
        const timeBetweenAppointments = document.getElementById('timeBetweenAppointments');
        const breakFrequency = document.getElementById('breakFrequency');
        const breakDuration = document.getElementById('breakDuration');
        const dailyBusinessHours = document.getElementById('dailyBusinessHours');

        // Appointments section
        const appointmentFilterEmployee = document.getElementById('appointmentFilterEmployee');
        const appointmentFilterService = document.getElementById('appointmentFilterService');
        const appointmentFilterDate = document.getElementById('appointmentFilterDate');
        const filterAppointmentsBtn = document.getElementById('filterAppointmentsBtn');
        const appointmentsTable = document.getElementById('appointmentsTable').querySelector('tbody');
        const noAppointments = document.getElementById('noAppointments');

        // Clients section
        const clientSearchInput = document.getElementById('clientSearchInput');
        const clientsTable = document.getElementById('clientsTable').querySelector('tbody');
        const noClients = document.getElementById('noClients');
        const clientDetailsModal = document.getElementById('clientDetailsModal');
        const clientDetailName = document.getElementById('clientDetailName');
        const clientDetailEmail = document.getElementById('clientDetailEmail');
        const clientDetailPhone = document.getElementById('clientDetailPhone');
        const clientAppointmentsHistory = document.getElementById('clientAppointmentsHistory');
        const noClientAppointments = document.getElementById('noClientAppointments');
        let currentClientData = null; // To store client data when modal is open

        // Absences section
        const addBusinessAbsenceForm = document.getElementById('addBusinessAbsenceForm');
        const employeeAbsenceRequests = document.getElementById('employeeAbsenceRequests');
        const noAbsenceRequests = document.getElementById('noAbsenceRequests');
        const approvedAbsencesCalendar = document.getElementById('approvedAbsencesCalendar');

        // Statistics section
        const statsStartDate = document.getElementById('statsStartDate');
        const statsEndDate = document.getElementById('statsEndDate');
        const generateStatsBtn = document.getElementById('generateStatsBtn');
        const totalRevenueDisplay = document.getElementById('totalRevenueDisplay');
        const revenueChart = document.getElementById('revenueChart');
        const employeeOccupancyChart = document.getElementById('employeeOccupancyChart');
        const popularServicesChart = document.getElementById('popularServicesChart');
        const peakHoursChart = document.getElementById('peakHoursChart');
        const reviewsSummaryChart = document.getElementById('reviewsSummaryChart');

        let revenueChartInstance = null;
        let employeeOccupancyChartInstance = null;
        let popularServicesChartInstance = null;
        let peakHoursChartInstance = null;
        let reviewsSummaryChartInstance = null;


        // Clock-in/Clock-out section
        const employeeClockName = document.getElementById('employeeClockName');
        const clockStatus = document.getElementById('clockStatus');
        const clockInBtn = document.getElementById('clockInBtn');
        const clockOutBtn = document.getElementById('clockOutBtn');
        const clockInTimeDisplay = document.getElementById('clockInTime');
        const clockOutTimeDisplay = document.getElementById('clockOutTime');
        const nextAppointmentDisplay = document.getElementById('nextAppointmentDisplay');
        const myAppointmentsEmployeeTable = document.getElementById('myAppointmentsEmployeeTable').querySelector('tbody');
        const noEmployeeAppointments = document.getElementById('noEmployeeAppointments');
        const requestAbsenceForm = document.getElementById('requestAbsenceForm');
        const specificHoursFields = document.getElementById('specificHoursFields');
        const pendingAbsenceRequests = document.getElementById('pendingAbsenceRequests');
        const noPendingAbsences = document.getElementById('noPendingAbsences');
        const longBreakBtn = document.getElementById('longBreakBtn');
        const urgentExitBtn = document.getElementById('urgentExitBtn');
        const addWalkInAppointmentBtn = document.getElementById('addWalkInAppointmentBtn');
        let clockInterval = null; // To update clock status periodically

        // --- Utility Functions ---
        function showLoading() { loadingScreen.style.display = 'flex'; }
        function hideLoading() { loadingScreen.style.display = 'none'; }
        function showModal(modalElement) { modalElement.style.display = 'flex'; }
        function hideModal(modalElement) { modalElement.style.display = 'none'; }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';

            document.querySelectorAll('.side-menu nav ul li a').forEach(link => {
                link.classList.remove('active');
            });
            // Set active class on the corresponding nav link
            const activeNavLink = document.querySelector(`#nav${sectionId.replace('Section', '')}`);
            if (activeNavLink) {
                activeNavLink.classList.add('active');
            }
        }

        // --- Authentication & Initialization ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentManagerUser = user;
                welcomeMessage.textContent = `שלום, ${user.email}`; // Fallback, will update with business/manager name

                // Try to fetch business data associated with this user
                const businessesRef = db.collection("businesses");
                const q = businessesRef.where("managerUid", "==", user.uid);
                const querySnapshot = await q.get();

                if (!querySnapshot.empty) {
                    currentBusinessId = querySnapshot.docs[0].id;
                    currentBusinessData = querySnapshot.docs[0].data();
                    businessDashboardTitle.textContent = currentBusinessData.name || 'פאנל ניהול';
                    welcomeMessage.textContent = `שלום, מנהל/ת ${currentBusinessData.name || ''}`;
                    adminDashboardLayout.style.display = 'flex';
                    hideLoading();
                    showSection('dashboardSection'); // Default to dashboard

                    // Check if current user is also an employee of this business
                    if (currentBusinessData.teamMembers && currentBusinessData.teamMembers.some(tm => tm.email === user.email)) {
                        currentEmployeeData = currentBusinessData.teamMembers.find(tm => tm.email === user.email);
                        navClock.style.display = 'block'; // Show clock-in/out for managers who are also employees
                        employeeClockName.textContent = currentEmployeeData.name || user.email;
                        await loadClockStatus();
                    } else {
                        navClock.style.display = 'none';
                    }

                    // Pre-fill general business settings if they exist
                    defaultAppointmentDuration.value = currentBusinessData.appointmentDuration || 30;
                    timeBetweenAppointments.value = currentBusinessData.breakBetweenAppointments || 0;
                    breakFrequency.value = currentBusinessData.regularBreakFrequency || 0;
                    breakDuration.value = currentBusinessData.regularBreakDuration || 0;

                    populateBusinessHoursForm(currentBusinessData.workDays || {});
                    loadDashboardData();
                } else {
                    // No business found for this manager, redirect to registration or prompt to create one
                    hideLoading();
                    showModal(registerModal); // Prompt to register a new business
                    adminDashboardLayout.style.display = 'none';
                }
            } else {
                currentManagerUser = null;
                currentBusinessId = null;
                currentBusinessData = null;
                currentEmployeeData = null;
                hideLoading();
                showModal(loginModal);
                adminDashboardLayout.style.display = 'none';
            }
        });

        // Event Listeners for Auth Modals
        loginModal.addEventListener('click', (e) => { if (e.target === loginModal) hideModal(loginModal); });
        registerModal.addEventListener('click', (e) => { if (e.target === registerModal) hideModal(registerModal); });

        switchToRegister.addEventListener('click', (e) => {
            e.preventDefault();
            hideModal(loginModal);
            showModal(registerModal);
        });

        switchToLogin.addEventListener('click', (e) => {
            e.preventDefault();
            hideModal(registerModal);
            showModal(loginModal);
        });

        document.querySelectorAll('.close-auth-modal').forEach(btn => {
            btn.addEventListener('click', () => {
                hideModal(loginModal);
                hideModal(registerModal);
            });
        });

        // Login Form Submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm.loginEmail.value;
            const password = loginForm.loginPassword.value;
            showLoading();
            try {
                await auth.signInWithEmailAndPassword(email, password);
                // Auth state listener handles redirect/display
            } catch (error) {
                alert('שגיאת התחברות: ' + error.message);
                console.error("Login error:", error);
                hideLoading();
            }
        });

        // Register Business Form Submission
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const businessName = document.getElementById('businessName').value;
            const businessType = document.getElementById('businessType').value;
            const businessAddress = document.getElementById('businessAddress').value;
            const businessPhone = document.getElementById('businessPhone').value;
            const businessDescription = document.getElementById('businessDescription').value;
            const logoFile = document.getElementById('businessLogoUpload').files[0];
            const imageFiles = document.getElementById('businessImagesUpload').files;

            const managerFullName = document.getElementById('managerFullName').value;
            const managerEmail = document.getElementById('managerEmail').value;
            const managerPassword = document.getElementById('managerPassword').value;
            const managerConfirmPassword = document.getElementById('managerConfirmPassword').value;

            if (managerPassword !== managerConfirmPassword) {
                alert("הסיסמאות אינן תואמות.");
                hideLoading();
                return;
            }
            if (managerPassword.length < 6) {
                alert("הסיסמה חייבת להיות באורך 6 תווים לפחות.");
                hideLoading();
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(managerEmail, managerPassword);
                const managerUid = userCredential.user.uid;

                let logoUrl = '';
                if (logoFile) {
                    const logoRef = storage.ref(`business_logos/${managerUid}/${logoFile.name}`);
                    await logoRef.put(logoFile);
                    logoUrl = await logoRef.getDownloadURL();
                }

                let imageUrls = [];
                for (const file of imageFiles) {
                    const imageRef = storage.ref(`business_images/${managerUid}/${file.name}`);
                    await imageRef.put(file);
                    imageUrls.push(await imageRef.getDownloadURL());
                }

                const newBusinessRef = db.collection("businesses").doc(); // Generate unique ID
                await newBusinessRef.set({
                    name: businessName,
                    type: businessType,
                    address: businessAddress,
                    phone: businessPhone,
                    description: businessDescription,
                    logoUrl: logoUrl,
                    imageUrls: imageUrls,
                    managerUid: managerUid,
                    createdAt: new Date().toISOString(),
                    // Default business hours
                    workDays: ["ראשון", "שני", "שלישי", "רביעי", "חמישי"],
                    openTime: "09:00",
                    closeTime: "17:00",
                    appointmentDuration: 30, // minutes
                    breakBetweenAppointments: 0, // minutes
                    regularBreakFrequency: 0, // every X appointments
                    regularBreakDuration: 0, // minutes
                    teamMembers: [{ id: managerUid, name: managerFullName, email: managerEmail, isManager: true, workHours: {} }],
                    services: [],
                    unavailableDates: [],
                    unavailableHours: []
                });

                // Update manager's user document with business ID (optional, but good for quick lookup)
                await db.collection("users").doc(managerUid).set({
                    businessId: newBusinessRef.id,
                    fullName: managerFullName,
                    email: managerEmail,
                    role: "manager", // Define user roles
                    createdAt: new Date().toISOString()
                }, { merge: true });

                alert('העסק נוצר בהצלחה!');
                // Auth state listener will now detect the new business and display dashboard
            } catch (error) {
                alert('שגיאת יצירת עסק: ' + error.message);
                console.error("Register business error:", error);
                hideLoading();
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            showLoading();
            try {
                await auth.signOut();
                alert("התנתקת בהצלחה.");
                // Auth state listener handles display
            } catch (error) {
                console.error("Error logging out:", error);
                alert("שגיאה בהתנתקות.");
                hideLoading();
            }
        });

        // --- Navigation ---
        navDashboard.addEventListener('click', (e) => { e.preventDefault(); showSection('dashboardSection'); loadDashboardData(); });
        navEmployees.addEventListener('click', (e) => { e.preventDefault(); showSection('employeesSection'); loadEmployees(); loadServicesForEmployeeAssignment(); });
        navServices.addEventListener('click', (e) => { e.preventDefault(); showSection('servicesSection'); loadServices(); loadEmployeesForServiceAssignment(); });
        navBusinessHours.addEventListener('click', (e) => { e.preventDefault(); showSection('businessHoursSection'); populateBusinessHoursForm(currentBusinessData.workDays || {}); });
        navAppointments.addEventListener('click', (e) => { e.preventDefault(); showSection('appointmentsSection'); loadAppointmentFilters(); loadAppointments(); });
        navClients.addEventListener('click', (e) => { e.preventDefault(); showSection('clientsSection'); loadClients(); });
        navAbsences.addEventListener('click', (e) => { e.preventDefault(); showSection('absencesSection'); loadBusinessAbsences(); loadEmployeeAbsenceRequests(); generateApprovedAbsencesCalendar(); });
        navStats.addEventListener('click', (e) => { e.preventDefault(); showSection('statsSection'); }); // Stats data will load on button click
        navClock.addEventListener('click', (e) => { e.preventDefault(); showSection('clockSection'); loadEmployeeAppointmentsAndStatus(); });


        // --- Dashboard Section Logic ---
        async function loadDashboardData() {
            if (!currentBusinessId) return;

            // Fetch upcoming appointments for today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);

            const todaysAppointmentsQuery = db.collection("appointments")
                .where("businessId", "==", currentBusinessId)
                .where("date", "==", today.toISOString().split('T')[0]);
                // Add more complex date range query if needed
            
            const todaysAppointmentsSnapshot = await todaysAppointmentsQuery.get();
            let todaysAppointments = [];
            let upcomingCount = 0; // for current and future appointments
            todaysAppointmentsSnapshot.forEach(doc => {
                const appt = doc.data();
                if (new Date(`${appt.date}T${appt.time}`) >= new Date()) { // Only count truly upcoming ones
                    upcomingCount++;
                }
                todaysAppointments.push({ id: doc.id, ...appt });
            });

            upcomingAppointmentsCount.textContent = upcomingCount;

            // Sort appointments by time for display
            todaysAppointments.sort((a, b) => {
                const timeA = new Date(`2000-01-01T${a.time}`);
                const timeB = new Date(`2000-01-01T${b.time}`);
                return timeA - timeB;
            });

            todaysAppointmentsTable.innerHTML = '';
            if (todaysAppointments.length === 0) {
                noTodaysAppointments.style.display = 'block';
            } else {
                noTodaysAppointments.style.display = 'none';
                todaysAppointments.forEach(appt => {
                    const row = todaysAppointmentsTable.insertRow();
                    row.innerHTML = `
                        <td>${appt.time}</td>
                        <td>${appt.userName}</td>
                        <td>${appt.serviceName}</td>
                        <td>${appt.teamMemberName || 'כל צוות העסק'}</td>
                        <td class="actions">
                            <button class="secondary edit-appt" data-id="${appt.id}">ערוך</button>
                            <button class="danger cancel-appt" data-id="${appt.id}">בטל</button>
                            <button class="primary complete-appt" data-id="${appt.id}" ${appt.status === 'completed' ? 'disabled' : ''}>${appt.status === 'completed' ? 'הושלם' : 'סמן כהושלם'}</button>
                        </td>
                    `;
                    row.querySelector('.cancel-appt').addEventListener('click', () => cancelAppointment(appt.id));
                    row.querySelector('.complete-appt').addEventListener('click', () => completeAppointment(appt.id));
                });
            }

            // Calculate daily revenue (simple sum, can be expanded)
            let totalDailyRevenue = 0;
            const completedAppointmentsToday = todaysAppointments.filter(appt => appt.status === 'completed');
            for (const appt of completedAppointmentsToday) {
                // Assuming service price is stored with the appointment or can be looked up
                // For this example, let's look it up from businessData.services
                const service = currentBusinessData.services.find(s => s.id === appt.serviceId);
                if (service && service.price) {
                    totalDailyRevenue += parseFloat(service.price);
                }
            }
            dailyRevenue.textContent = `${totalDailyRevenue.toFixed(2)} ₪`;

            // Fetch new reviews (e.g., from last 24 hours or just unread, simplified here)
            const reviewsQuery = db.collection("reviews")
                .where("businessId", "==", currentBusinessId);
                // Add filter for "new" if a timestamp is stored for read/unread
            
            const reviewsSnapshot = await reviewsQuery.get();
            newReviewsCount.textContent = reviewsSnapshot.docs.length; // Count all for now
        }

        async function cancelAppointment(apptId) {
            if (confirm('האם אתה בטוח שברצונך לבטל תור זה?')) {
                try {
                    await db.collection("appointments").doc(apptId).update({
                        status: 'cancelled',
                        cancelledAt: new Date().toISOString()
                    });
                    alert('התור בוטל בהצלחה.');
                    loadDashboardData(); // Refresh dashboard
                    loadAppointments(); // Refresh general appointments list
                } catch (error) {
                    console.error("Error cancelling appointment:", error);
                    alert('שגיאה בביטול התור: ' + (error.message || error));
                }
            }
        }

        async function completeAppointment(apptId) {
            if (confirm('האם אתה בטוח שברצונך לסמן תור זה כהושלם?')) {
                try {
                    await db.collection("appointments").doc(apptId).update({
                        status: 'completed',
                        completedAt: new Date().toISOString()
                    });
                    alert('התור סומן כהושלם.');
                    loadDashboardData(); // Refresh dashboard
                    loadAppointments(); // Refresh general appointments list
                } catch (error) {
                    console.error("Error completing appointment:", error);
                    alert('שגיאה בסימון התור כהושלם: ' + (error.message || error));
                }
            }
        }


        // --- Employees Section Logic ---
        addEmployeeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('employeeName').value;
            const email = document.getElementById('employeeEmail').value;
            const password = document.getElementById('employeePassword').value;

            if (password.length < 6) {
                alert("הסיסמה חייבת להיות באורך 6 תווים לפחות.");
                return;
            }

            try {
                // Create Firebase Auth user for employee
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const employeeUid = userCredential.user.uid;

                // Add employee to business's teamMembers array
                const businessRef = db.collection("businesses").doc(currentBusinessId);
                await businessRef.update({
                    teamMembers: firebase.firestore.FieldValue.arrayUnion({
                        id: employeeUid,
                        name: name,
                        email: email,
                        isManager: false,
                        workHours: {} // Empty object for custom work hours
                    })
                });

                // Create a basic user document for the employee (optional, but good for general user management)
                await db.collection("users").doc(employeeUid).set({
                    businessId: currentBusinessId,
                    fullName: name,
                    email: email,
                    role: "employee", // Define user roles
                    createdAt: new Date().toISOString()
                }, { merge: true });

                alert('עובד נוסף בהצלחה!');
                addEmployeeForm.reset();
                await loadEmployees(); // Refresh list
                await updateCurrentBusinessData(); // Refresh global business data
            } catch (error) {
                alert('שגיאה בהוספת עובד: ' + error.message);
                console.error("Add employee error:", error);
            }
        });

        async function loadEmployees() {
            if (!currentBusinessData || !currentBusinessData.teamMembers) {
                employeesTable.innerHTML = '';
                noEmployees.style.display = 'block';
                return;
            }

            const employees = currentBusinessData.teamMembers;
            employeesTable.innerHTML = '';
            if (employees.length === 0) {
                noEmployees.style.display = 'block';
            } else {
                noEmployees.style.display = 'none';
                employees.forEach(employee => {
                    const row = employeesTable.insertRow();
                    row.innerHTML = `
                        <td>${employee.name}</td>
                        <td>${employee.email}</td>
                        <td class="actions">
                            <button class="secondary view-employee-details" data-id="${employee.id}">פרטים / ערוך</button>
                            <button class="danger delete-employee" data-id="${employee.id}">מחק</button>
                        </td>
                    `;
                    row.querySelector('.view-employee-details').addEventListener('click', () => showEmployeeDetails(employee));
                    row.querySelector('.delete-employee').addEventListener('click', () => deleteEmployee(employee.id));
                });
            }
        }

        async function deleteEmployee(employeeId) {
            if (confirm('האם אתה בטוח שברצונך למחוק עובד זה? פעולה זו אינה הפיכה ותמחק את כל הקשור לעובד (כולל תורים עתידיים).')) {
                try {
                    // Remove from business teamMembers array
                    const employeeToDelete = currentBusinessData.teamMembers.find(e => e.id === employeeId);
                    if (employeeToDelete) {
                        const businessRef = db.collection("businesses").doc(currentBusinessId);
                        await businessRef.update({
                            teamMembers: firebase.firestore.FieldValue.arrayRemove(employeeToDelete)
                        });
                        alert('עובד נמחק בהצלחה.');
                        await updateCurrentBusinessData(); // Refresh global business data
                        await loadEmployees(); // Refresh list
                        // TODO: Also delete Firebase Auth user, but this needs Admin SDK or Cloud Function for security
                        // For now, the Auth user will remain but cannot access the business dashboard/employee features.
                    }
                } catch (error) {
                    console.error("Error deleting employee:", error);
                    alert('שגיאה במחיקת עובד: ' + (error.message || error));
                }
            }
        }


        async function showEmployeeDetails(employee) {
            currentEmployeeIdForDetails = employee.id;
            employeeDetailName.textContent = employee.name;
            employeeDetailEmail.textContent = employee.email;

            // Load all services for checkbox assignment
            employeeServicesCheckboxes.innerHTML = '';
            if (currentBusinessData && currentBusinessData.services) {
                currentBusinessData.services.forEach(service => {
                    const div = document.createElement('div');
                    div.className = 'service-checkbox';
                    div.innerHTML = `
                        <input type="checkbox" id="service-${service.id}" value="${service.id}" ${service.assignedTeamMembers && service.assignedTeamMembers.includes(employee.id) ? 'checked' : ''}>
                        <label for="service-${service.id}">${service.name}</label>
                    `;
                    employeeServicesCheckboxes.appendChild(div);
                });
            } else {
                employeeServicesCheckboxes.innerHTML = '<p>אין שירותים להצגה.</p>';
            }

            // Populate employee availability form
            employeeAvailabilityForm.innerHTML = '';
            const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
            dayNames.forEach(day => {
                const dayHours = employee.workHours ? employee.workHours[day] : null;
                const isWorking = dayHours ? dayHours.isWorking : currentBusinessData.workDays.includes(day); // Default to business work days
                const openTime = dayHours && dayHours.openTime ? dayHours.openTime : currentBusinessData.openTime || '09:00';
                const closeTime = dayHours && dayHours.closeTime ? dayHours.closeTime : currentBusinessData.closeTime || '17:00';

                const div = document.createElement('div');
                div.className = 'day-hours';
                div.innerHTML = `
                    <span>${day}:</span>
                    <input type="checkbox" id="employee-${day}-working" data-day="${day}" ${isWorking ? 'checked' : ''}>
                    <label for="employee-${day}-working">עובד/ת</label>
                    <input type="time" id="employee-${day}-open" value="${openTime}" ${!isWorking ? 'disabled' : ''}>
                    <input type="time" id="employee-${day}-close" value="${closeTime}" ${!isWorking ? 'disabled' : ''}>
                `;
                employeeAvailabilityForm.appendChild(div);

                const workingCheckbox = div.querySelector(`#employee-${day}-working`);
                const openTimeInput = div.querySelector(`#employee-${day}-open`);
                const closeTimeInput = div.querySelector(`#employee-${day}-close`);

                workingCheckbox.addEventListener('change', () => {
                    openTimeInput.disabled = !workingCheckbox.checked;
                    closeTimeInput.disabled = !workingCheckbox.checked;
                });
            });

            showModal(employeeDetailsModal);
        }

        saveEmployeeServices.addEventListener('click', async () => {
            if (!currentEmployeeIdForDetails || !currentBusinessId) return;

            try {
                const businessRef = db.collection("businesses").doc(currentBusinessId);
                // Fetch current business data to ensure we have the latest services array
                const businessDoc = await businessRef.get();
                let currentServices = businessDoc.data().services || [];

                // Update assignedTeamMembers for each service based on checkboxes
                document.querySelectorAll('#employeeServicesCheckboxes input[type="checkbox"]').forEach(checkbox => {
                    const serviceId = checkbox.value;
                    const isChecked = checkbox.checked;

                    const serviceIndex = currentServices.findIndex(s => s.id === serviceId);
                    if (serviceIndex !== -1) {
                        let assignedMembers = currentServices[serviceIndex].assignedTeamMembers || [];
                        if (isChecked && !assignedMembers.includes(currentEmployeeIdForDetails)) {
                            assignedMembers.push(currentEmployeeIdForDetails);
                        } else if (!isChecked && assignedMembers.includes(currentEmployeeIdForDetails)) {
                            assignedMembers = assignedMembers.filter(id => id !== currentEmployeeIdForDetails);
                        }
                        currentServices[serviceIndex].assignedTeamMembers = assignedMembers;
                    }
                });

                await businessRef.update({ services: currentServices });
                alert("שירותי העובד עודכנו בהצלחה!");
                await updateCurrentBusinessData(); // Refresh global business data
                hideModal(employeeDetailsModal);
                loadEmployees(); // Reload employee list to reflect changes if needed
            } catch (error) {
                console.error("Error saving employee services:", error);
                alert("שגיאה בשמירת שירותי העובד: " + (error.message || error));
            }
        });

        saveEmployeeAvailability.addEventListener('click', async () => {
            if (!currentEmployeeIdForDetails || !currentBusinessId) return;

            try {
                const businessRef = db.collection("businesses").doc(currentBusinessId);
                const businessDoc = await businessRef.get();
                let teamMembers = businessDoc.data().teamMembers || [];

                const employeeIndex = teamMembers.findIndex(e => e.id === currentEmployeeIdForDetails);
                if (employeeIndex !== -1) {
                    let employeeWorkHours = {};
                    document.querySelectorAll('#employeeAvailabilityForm .day-hours').forEach(dayDiv => {
                        const day = dayDiv.querySelector('input[type="checkbox"]').dataset.day;
                        const isWorking = dayDiv.querySelector('input[type="checkbox"]').checked;
                        const openTime = dayDiv.querySelector('input[type="time"]').value;
                        const closeTime = dayDiv.querySelector('input[type="time"]').value;

                        employeeWorkHours[day] = {
                            isWorking: isWorking,
                            openTime: isWorking ? openTime : '',
                            closeTime: isWorking ? closeTime : ''
                        };
                    });
                    teamMembers[employeeIndex].workHours = employeeWorkHours;
                    await businessRef.update({ teamMembers: teamMembers });
                    alert("זמינות העובד עודכנה בהצלחה!");
                    await updateCurrentBusinessData(); // Refresh global business data
                    hideModal(employeeDetailsModal);
                }
            } catch (error) {
                console.error("Error saving employee availability:", error);
                alert("שגיאה בשמירת זמינות העובד: " + (error.message || error));
            }
        });

        document.querySelectorAll('.close-employee-modal').forEach(btn => {
            btn.addEventListener('click', () => hideModal(employeeDetailsModal));
        });
        employeeDetailsModal.addEventListener('click', (e) => {
            if (e.target === employeeDetailsModal) hideModal(employeeDetailsModal);
        });


        // --- Services Section Logic ---
        addServiceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('serviceName').value;
            const description = document.getElementById('serviceDescription').value;
            const price = parseFloat(document.getElementById('servicePrice').value);
            const duration = parseInt(document.getElementById('serviceDuration').value);

            // Get selected employees
            const assignedTeamMembers = Array.from(document.querySelectorAll('#serviceEmployeesCheckboxes input:checked'))
                                            .map(checkbox => checkbox.value);

            try {
                const businessRef = db.collection("businesses").doc(currentBusinessId);
                const newServiceId = db.collection("businesses").doc(currentBusinessId).collection("services").doc().id; // Generate unique ID

                await businessRef.update({
                    services: firebase.firestore.FieldValue.arrayUnion({
                        id: newServiceId, // Assign a unique ID for the service
                        name: name,
                        description: description,
                        price: price,
                        duration: duration,
                        assignedTeamMembers: assignedTeamMembers
                    })
                });
                alert('שירות נוסף בהצלחה!');
                addServiceForm.reset();
                await loadServices(); // Refresh list
                await updateCurrentBusinessData(); // Refresh global business data
            } catch (error) {
                alert('שגיאה בהוספת שירות: ' + error.message);
                console.error("Add service error:", error);
            }
        });

        async function loadServices() {
            if (!currentBusinessData || !currentBusinessData.services) {
                servicesTable.innerHTML = '';
                noServices.style.display = 'block';
                return;
            }

            const services = currentBusinessData.services;
            servicesTable.innerHTML = '';
            if (services.length === 0) {
                noServices.style.display = 'block';
            } else {
                noServices.style.display = 'none';
                services.forEach(service => {
                    const assignedNames = (service.assignedTeamMembers || [])
                        .map(memberId => {
                            const member = currentBusinessData.teamMembers.find(tm => tm.id === memberId);
                            return member ? member.name : 'לא ידוע';
                        })
                        .join(', ');

                    const row = servicesTable.insertRow();
                    row.innerHTML = `
                        <td>${service.name}</td>
                        <td>${service.price ? service.price.toFixed(2) : 'N/A'}</td>
                        <td>${service.duration || 'N/A'}</td>
                        <td>${assignedNames || 'לא הוגדר'}</td>
                        <td class="actions">
                            <button class="secondary edit-service" data-id="${service.id}">ערוך</button>
                            <button class="danger delete-service" data-id="${service.id}">מחק</button>
                        </td>
                    `;
                    row.querySelector('.delete-service').addEventListener('click', () => deleteService(service.id));
                    row.querySelector('.edit-service').addEventListener('click', () => editService(service));
                });
            }
        }

        async function deleteService(serviceId) {
            if (confirm('האם אתה בטוח שברצונך למחוק שירות זה?')) {
                try {
                    const serviceToDelete = currentBusinessData.services.find(s => s.id === serviceId);
                    if (serviceToDelete) {
                        const businessRef = db.collection("businesses").doc(currentBusinessId);
                        await businessRef.update({
                            services: firebase.firestore.FieldValue.arrayRemove(serviceToDelete)
                        });
                        alert('שירות נמחק בהצלחה.');
                        await updateCurrentBusinessData(); // Refresh global business data
                        await loadServices(); // Refresh list
                    }
                } catch (error) {
                    console.error("Error deleting service:", error);
                    alert('שגיאה במחיקת שירות: ' + (error.message || error));
                }
            }
        }

        function editService(service) {
            // For editing, populate the form with existing service data
            document.getElementById('serviceName').value = service.name;
            document.getElementById('serviceDescription').value = service.description || '';
            document.getElementById('servicePrice').value = service.price || '';
            document.getElementById('serviceDuration').value = service.duration || '';

            // Update employee checkboxes for this service
            document.querySelectorAll('#serviceEmployeesCheckboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = service.assignedTeamMembers && service.assignedTeamMembers.includes(checkbox.value);
            });

            // Change form submit to update instead of add
            addServiceForm.onsubmit = async (e) => {
                e.preventDefault();
                const updatedName = document.getElementById('serviceName').value;
                const updatedDescription = document.getElementById('serviceDescription').value;
                const updatedPrice = parseFloat(document.getElementById('servicePrice').value);
                const updatedDuration = parseInt(document.getElementById('serviceDuration').value);
                const updatedAssignedTeamMembers = Array.from(document.querySelectorAll('#serviceEmployeesCheckboxes input:checked'))
                                                        .map(checkbox => checkbox.value);

                try {
                    const businessRef = db.collection("businesses").doc(currentBusinessId);
                    const businessDoc = await businessRef.get();
                    let currentServices = businessDoc.data().services || [];

                    const serviceIndex = currentServices.findIndex(s => s.id === service.id);
                    if (serviceIndex !== -1) {
                        currentServices[serviceIndex] = {
                            id: service.id, // Keep original ID
                            name: updatedName,
                            description: updatedDescription,
                            price: updatedPrice,
                            duration: updatedDuration,
                            assignedTeamMembers: updatedAssignedTeamMembers
                        };
                        await businessRef.update({ services: currentServices });
                        alert('שירות עודכן בהצלחה!');
                        addServiceForm.reset();
                        addServiceForm.onsubmit = addServiceFormDefaultSubmit; // Revert to default add
                        await loadServices();
                        await updateCurrentBusinessData();
                    }
                } catch (error) {
                    alert('שגיאה בעדכון שירות: ' + error.message);
                    console.error("Update service error:", error);
                }
            };
        }

        // Store default submit for services form
        const addServiceFormDefaultSubmit = addServiceForm.onsubmit;

        async function loadEmployeesForServiceAssignment() {
            serviceEmployeesCheckboxes.innerHTML = '';
            if (currentBusinessData && currentBusinessData.teamMembers) {
                currentBusinessData.teamMembers.forEach(employee => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item'; // Use a class for consistency
                    div.innerHTML = `
                        <input type="checkbox" id="service-assign-${employee.id}" value="${employee.id}">
                        <label for="service-assign-${employee.id}">${employee.name}</label>
                    `;
                    serviceEmployeesCheckboxes.appendChild(div);
                });
            } else {
                serviceEmployeesCheckboxes.innerHTML = '<p>אין עובדים להצגה.</p>';
            }
        }


        // --- Business Hours Section Logic ---
        function populateBusinessHoursForm(workDaysConfig) {
            dailyBusinessHours.innerHTML = '';
            const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
            dayNames.forEach(day => {
                const div = document.createElement('div');
                div.className = 'form-group day-hours';
                const isChecked = currentBusinessData.workDays && currentBusinessData.workDays.includes(day);
                const openTime = currentBusinessData.openTime || '09:00';
                const closeTime = currentBusinessData.closeTime || '17:00';

                div.innerHTML = `
                    <span>${day}:</span>
                    <input type="checkbox" id="business-day-${day}" data-day="${day}" ${isChecked ? 'checked' : ''}>
                    <label for="business-day-${day}">פתוח</label>
                    <input type="time" id="business-open-${day}" value="${openTime}" ${!isChecked ? 'disabled' : ''}>
                    <input type="time" id="business-close-${day}" value="${closeTime}" ${!isChecked ? 'disabled' : ''}>
                `;
                dailyBusinessHours.appendChild(div);

                const checkbox = div.querySelector(`#business-day-${day}`);
                const openInput = div.querySelector(`#business-open-${day}`);
                const closeInput = div.querySelector(`#business-close-${day}`);

                checkbox.addEventListener('change', () => {
                    openInput.disabled = !checkbox.checked;
                    closeInput.disabled = !checkbox.checked;
                });
            });
        }

        businessHoursForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentBusinessId) return;

            const updatedWorkDays = [];
            document.querySelectorAll('#dailyBusinessHours input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    updatedWorkDays.push(checkbox.dataset.day);
                }
            });

            // Assuming all active days have the same open/close times for the business general setting
            // Individual employee hours override this.
            const generalOpenTime = document.getElementById('business-open-ראשון').value; // Example, taking from Sunday
            const generalCloseTime = document.getElementById('business-close-ראשון').value; // Example

            const apptDuration = parseInt(defaultAppointmentDuration.value);
            const breakBetween = parseInt(timeBetweenAppointments.value);
            const freqBreak = parseInt(breakFrequency.value);
            const durBreak = parseInt(breakDuration.value);

            try {
                const businessRef = db.collection("businesses").doc(currentBusinessId);
                await businessRef.update({
                    workDays: updatedWorkDays,
                    openTime: generalOpenTime,
                    closeTime: generalCloseTime,
                    appointmentDuration: apptDuration,
                    breakBetweenAppointments: breakBetween,
                    regularBreakFrequency: freqBreak,
                    regularBreakDuration: durBreak
                });
                alert('שעות הפעילות עודכנו בהצלחה!');
                await updateCurrentBusinessData(); // Refresh global business data
            } catch (error) {
                console.error("Error updating business hours:", error);
                alert('שגיאה בעדכון שעות פעילות: ' + (error.message || error));
            }
        });

        // --- Appointments Section Logic ---
        async function loadAppointmentFilters() {
            // Populate employee filter
            appointmentFilterEmployee.innerHTML = '<option value="">כל העובדים</option>';
            if (currentBusinessData && currentBusinessData.teamMembers) {
                currentBusinessData.teamMembers.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = employee.name;
                    appointmentFilterEmployee.appendChild(option);
                });
            }

            // Populate service filter
            appointmentFilterService.innerHTML = '<option value="">כל השירותים</option>';
            if (currentBusinessData && currentBusinessData.services) {
                currentBusinessData.services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = service.name;
                    appointmentFilterService.appendChild(option);
                });
            }
        }

        filterAppointmentsBtn.addEventListener('click', loadAppointments);

        async function loadAppointments() {
            if (!currentBusinessId) return;

            appointmentsTable.innerHTML = '';
            noAppointments.style.display = 'block';

            let q = db.collection("appointments").where("businessId", "==", currentBusinessId);

            const filterEmployeeId = appointmentFilterEmployee.value;
            const filterServiceId = appointmentFilterService.value;
            const filterDate = appointmentFilterDate.value;

            if (filterEmployeeId) {
                q = q.where("teamMemberId", "==", filterEmployeeId);
            }
            if (filterServiceId) {
                q = q.where("serviceId", "==", filterServiceId);
            }
            if (filterDate) {
                q = q.where("date", "==", filterDate);
            }

            try {
                const querySnapshot = await q.get();
                let appointments = [];
                querySnapshot.forEach(doc => {
                    appointments.push({ id: doc.id, ...doc.data() });
                });

                if (appointments.length === 0) {
                    appointmentsTable.innerHTML = '';
                    noAppointments.style.display = 'block';
                    return;
                }

                noAppointments.style.display = 'none';
                appointments.sort((a, b) => {
                    const dateTimeA = new Date(`${a.date}T${a.time}`);
                    const dateTimeB = new Date(`${b.date}T${b.time}`);
                    return dateTimeA - dateTimeB;
                });

                appointments.forEach(appt => {
                    const row = appointmentsTable.insertRow();
                    row.innerHTML = `
                        <td>${appt.userName}</td>
                        <td>${appt.userEmail}</td>
                        <td>${appt.serviceName}</td>
                        <td>${appt.teamMemberName || 'N/A'}</td>
                        <td>${appt.date}</td>
                        <td>${appt.time}</td>
                        <td>${appt.status}</td>
                        <td class="actions">
                            <button class="secondary edit-appointment" data-id="${appt.id}">ערוך</button>
                            <button class="danger delete-appointment" data-id="${appt.id}">מחק</button>
                            <button class="primary status-appointment" data-id="${appt.id}" data-status="${appt.status}">
                                ${appt.status === 'completed' ? 'הושלם' : appt.status === 'cancelled' ? 'בוטל' : 'סמן כהושלם'}
                            </button>
                        </td>
                    `;
                    row.querySelector('.delete-appointment').addEventListener('click', () => deleteAppointmentPermanently(appt.id));
                    row.querySelector('.status-appointment').addEventListener('click', (e) => {
                        const newStatus = e.target.dataset.status === 'completed' ? 'pending' : 'completed'; // Toggle logic example
                        updateAppointmentStatus(appt.id, newStatus);
                    });
                    // Edit functionality is more complex, might open a modal with fields
                });

            } catch (error) {
                console.error("Error loading appointments:", error);
                appointmentsTable.innerHTML = `<p style="text-align: center; color: red;">שגיאה בטעינת תורים: ${error.message}</p>`;
                noAppointments.style.display = 'none';
            }
        }

        async function deleteAppointmentPermanently(apptId) {
            if (confirm('האם אתה בטוח שברצונך למחוק תור זה לצמיתות?')) {
                try {
                    await db.collection("appointments").doc(apptId).delete();
                    alert('התור נמחק לצמיתות.');
                    loadAppointments(); // Refresh list
                    loadDashboardData(); // Refresh dashboard
                } catch (error) {
                    console.error("Error deleting appointment permanently:", error);
                    alert('שגיאה במחיקת תור לצמיתות: ' + (error.message || error));
                }
            }
        }

        async function updateAppointmentStatus(apptId, newStatus) {
            try {
                await db.collection("appointments").doc(apptId).update({
                    status: newStatus,
                    updatedAt: new Date().toISOString()
                });
                alert(`סטטוס התור עודכן ל-${newStatus}.`);
                loadAppointments(); // Refresh list
                loadDashboardData(); // Refresh dashboard
            } catch (error) {
                console.error("Error updating appointment status:", error);
                alert('שגיאה בעדכון סטטוס תור: ' + (error.message || error));
            }
        }


        // --- Clients Section Logic ---
        clientSearchInput.addEventListener('input', loadClients);

        async function loadClients() {
            if (!currentBusinessId) return;

            clientsTable.innerHTML = '';
            noClients.style.display = 'block';

            const searchTerm = clientSearchInput.value.toLowerCase();
            let clientsMap = new Map(); // Use map to store unique clients and their appointment count

            try {
                const q = db.collection("appointments")
                    .where("businessId", "==", currentBusinessId);
                
                const querySnapshot = await q.get();

                querySnapshot.forEach(docSnap => {
                    const appt = docSnap.data();
                    if (appt.userId) { // Ensure appointment is linked to a user
                        let client = clientsMap.get(appt.userId);
                        if (!client) {
                            client = {
                                id: appt.userId,
                                name: appt.userName,
                                email: appt.userEmail,
                                phone: appt.userPhone || 'N/A', // Assuming phone might be stored with appointment or user doc
                                appointmentCount: 0
                            };
                        }
                        client.appointmentCount++;
                        clientsMap.set(appt.userId, client);
                    }
                });

                let clients = Array.from(clientsMap.values());

                if (searchTerm) {
                    clients = clients.filter(client =>
                        client.name.toLowerCase().includes(searchTerm) ||
                        client.email.toLowerCase().includes(searchTerm)
                    );
                }

                if (clients.length === 0) {
                    clientsTable.innerHTML = '';
                    noClients.style.display = 'block';
                    return;
                }

                noClients.style.display = 'none';
                clients.forEach(client => {
                    const row = clientsTable.insertRow();
                    row.innerHTML = `
                        <td>${client.name}</td>
                        <td>${client.email}</td>
                        <td>${client.phone}</td>
                        <td>${client.appointmentCount}</td>
                        <td class="actions">
                            <button class="secondary view-client-details" data-id="${client.id}">פרטים / היסטוריה</button>
                        </td>
                    `;
                    row.querySelector('.view-client-details').addEventListener('click', () => showClientDetails(client));
                });

            } catch (error) {
                console.error("Error loading clients:", error);
                clientsTable.innerHTML = `<p style="text-align: center; color: red;">שגיאה בטעינת לקוחות: ${error.message}</p>`;
                noClients.style.display = 'none';
            }
        }

        async function showClientDetails(client) {
            currentClientData = client;
            clientDetailName.textContent = client.name;
            clientDetailEmail.textContent = client.email;
            clientDetailPhone.textContent = client.phone;

            clientAppointmentsHistory.innerHTML = '';
            noClientAppointments.style.display = 'block';

            try {
                const q = db.collection("appointments")
                    .where("businessId", "==", currentBusinessId)
                    .where("userId", "==", client.id);
                
                const querySnapshot = await q.get();

                if (querySnapshot.empty) {
                    clientAppointmentsHistory.innerHTML = '';
                    noClientAppointments.style.display = 'block';
                    showModal(clientDetailsModal);
                    return;
                }

                noClientAppointments.style.display = 'none';
                const clientAppts = [];
                querySnapshot.forEach(docSnap => clientAppts.push(docSnap.data()));

                clientAppts.sort((a, b) => new Date(`${b.date}T${b.time}`) - new Date(`${a.date}T${a.time}`)); // Newest first

                clientAppts.forEach(appt => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <strong>${appt.date} ${appt.time}</strong> - ${appt.serviceName} (${appt.teamMemberName || 'צוות העסק'}) - סטטוס: ${appt.status}
                    `;
                    clientAppointmentsHistory.appendChild(li);
                });

            } catch (error) {
                console.error("Error loading client appointments history:", error);
                clientAppointmentsHistory.innerHTML = `<p style="text-align: center; color: red;">שגיאה בטעינת היסטוריית תורים: ${error.message}</p>`;
                noClientAppointments.style.display = 'none';
            }

            showModal(clientDetailsModal);
        }

        document.querySelectorAll('.close-client-modal').forEach(btn => {
            btn.addEventListener('click', () => hideModal(clientDetailsModal));
        });
        clientDetailsModal.addEventListener('click', (e) => {
            if (e.target === clientDetailsModal) hideModal(clientDetailsModal);
        });


        // --- Absences & Holidays Section Logic ---
        addBusinessAbsenceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const reason = document.getElementById('businessAbsenceReason').value;
            const startDate = document.getElementById('businessAbsenceStartDate').value;
            const endDate = document.getElementById('businessAbsenceEndDate').value;

            if (new Date(startDate) > new Date(endDate)) {
                alert("תאריך התחלה חייב להיות לפני או זהה לתאריך סיום.");
                return;
            }

            try {
                const businessRef = db.collection("businesses").doc(currentBusinessId);
                await businessRef.update({
                    unavailableDates: firebase.firestore.FieldValue.arrayUnion({
                        reason: reason,
                        startDate: startDate,
                        endDate: endDate,
                        type: 'business_closure'
                    })
                });
                alert('השבתה כלל עסקית נוספה בהצלחה!');
                addBusinessAbsenceForm.reset();
                await updateCurrentBusinessData();
                loadBusinessAbsences();
                generateApprovedAbsencesCalendar(); // Update calendar
            } catch (error) {
                console.error("Error adding business absence:", error);
                alert('שגיאה בהוספת השבתה: ' + (error.message || error));
            }
        });

        async function loadBusinessAbsences() {
            // Display existing business-wide closures (not employee requests)
            // This is currently directly from currentBusinessData.unavailableDates.
            // If you need a list to manage/delete, you'd iterate and create elements here.
            // For now, it mainly feeds into the calendar and appointment booking logic.
        }

        async function loadEmployeeAbsenceRequests() {
            employeeAbsenceRequests.innerHTML = '';
            noAbsenceRequests.style.display = 'block';

            try {
                const q = db.collection("absence_requests")
                    .where("businessId", "==", currentBusinessId)
                    .where("status", "==", "pending"); // Only show pending requests
                
                const querySnapshot = await q.get();

                if (querySnapshot.empty) {
                    employeeAbsenceRequests.innerHTML = '';
                    noAbsenceRequests.style.display = 'block';
                    return;
                }

                noAbsenceRequests.style.display = 'none';
                querySnapshot.forEach(docSnap => {
                    const request = docSnap.data();
                    const requestId = docSnap.id;
                    const employeeName = currentBusinessData.teamMembers.find(e => e.id === request.employeeId)?.name || 'עובד לא ידוע';

                    const div = document.createElement('div');
                    div.className = 'absence-entry';
                    let displayDates = `${request.date}`;
                    if (request.type === 'fullDay') {
                        displayDates = `יום שלם: ${request.date}`;
                    } else if (request.type === 'specificHours') {
                        displayDates = `שעות: ${request.date}, ${request.startTime}-${request.endTime}`;
                    }

                    div.innerHTML = `
                        <span><strong>${employeeName}</strong> ביקש חופשה: ${displayDates} (סיבה: ${request.reason || 'אין'})</span>
                        <button class="primary approve-absence" data-id="${requestId}">אשר</button>
                        <button class="danger reject-absence" data-id="${requestId}">דחה</button>
                    `;
                    employeeAbsenceRequests.appendChild(div);

                    div.querySelector('.approve-absence').addEventListener('click', () => approveAbsenceRequest(requestId, request));
                    div.querySelector('.reject-absence').addEventListener('click', () => rejectAbsenceRequest(requestId));
                });

            } catch (error) {
                console.error("Error loading employee absence requests:", error);
                employeeAbsenceRequests.innerHTML = `<p style="text-align: center; color: red;">שגיאה בטעינת בקשות חופשה.</p>`;
                noAbsenceRequests.style.display = 'none';
            }
        }

        async function approveAbsenceRequest(requestId, requestData) {
            try {
                const requestRef = db.collection("absence_requests").doc(requestId);
                await requestRef.update({ status: 'approved', approvedAt: new Date().toISOString() });

                // Add to business unavailableDates or update employee workHours based on request type
                const businessRef = db.collection("businesses").doc(currentBusinessId);
                const businessDoc = await businessRef.get();
                const currentTeamMembers = businessDoc.data().teamMembers || [];

                if (requestData.type === 'fullDay') {
                    // Option 1: Add to business's general unavailable dates (affects all)
                    // await businessRef.update({
                    //     unavailableDates: firebase.firestore.FieldValue.arrayUnion({
                    //         startDate: requestData.date,
                    //         endDate: requestData.date,
                    //         reason: requestData.reason,
                    //         type: 'employee_absence',
                    //         employeeId: requestData.employeeId
                    //     })
                    // });

                    // Option 2 (Better): Block specific employee's work hours for that day
                    // This requires updating the employee's workHours for that specific date/day
                    // For simplicity, let's just mark the employee's workhours for that day as not working
                    const employeeIndex = currentTeamMembers.findIndex(tm => tm.id === requestData.employeeId);
                    if(employeeIndex !== -1) {
                        const dayName = new Date(requestData.date).toLocaleDateString('he-IL', { weekday: 'long' }); // Get day name
                        const updatedWorkHours = { ...currentTeamMembers[employeeIndex].workHours,
                            [dayName]: { isWorking: false, openTime: '', closeTime: '' } // Mark as not working for that specific day
                        };
                        currentTeamMembers[employeeIndex].workHours = updatedWorkHours;
                        await businessRef.update({ teamMembers: currentTeamMembers });
                    }

                } else if (requestData.type === 'specificHours') {
                    // Add to business's unavailableHours for specific employee on specific date
                    // This is for blocking specific slots *within* a working day
                    await businessRef.update({
                        unavailableHours: firebase.firestore.FieldValue.arrayUnion({
                            date: requestData.date,
                            startTime: requestData.startTime,
                            endTime: requestData.endTime,
                            employeeId: requestData.employeeId,
                            reason: requestData.reason,
                            type: 'employee_absence_hours'
                        })
                    });
                }
                alert('בקשת חופשה אושרה בהצלחה!');
                await updateCurrentBusinessData();
                loadEmployeeAbsenceRequests();
                generateApprovedAbsencesCalendar(); // Update calendar
            } catch (error) {
                console.error("Error approving absence request:", error);
                alert('שגיאה באישור בקשת חופשה: ' + (error.message || error));
            }
        }

        async function rejectAbsenceRequest(requestId) {
            if (confirm('האם אתה בטוח שברצונך לדחות בקשת חופשה זו?')) {
                try {
                    const requestRef = db.collection("absence_requests").doc(requestId);
                    await requestRef.update({ status: 'rejected', rejectedAt: new Date().toISOString() });
                    alert('בקשת חופשה נדחתה.');
                    loadEmployeeAbsenceRequests();
                } catch (error) {
                    console.error("Error rejecting absence request:", error);
                    alert('שגיאה בדחיית בקשת חופשה: ' + (error.message || error));
                }
            }
        }

        function generateApprovedAbsencesCalendar() {
            approvedAbsencesCalendar.innerHTML = '<h3>יומן חופשות מאושרות (חודש נוכחי + הבא)</h3>';
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-indexed

            const dayNames = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש']; // Short day names for calendar header

            for (let monthOffset = 0; monthOffset < 2; monthOffset++) { // Current and next month
                const displayMonth = new Date(currentYear, currentMonth + monthOffset, 1);
                const numDays = new Date(currentYear, currentMonth + monthOffset + 1, 0).getDate();
                const firstDayOfWeek = displayMonth.getDay(); // Day of week (0-6) for 1st day of month

                const monthTitle = displayMonth.toLocaleDateString('he-IL', { month: 'long', year: 'numeric' });
                const monthHeader = document.createElement('h4');
                monthHeader.textContent = monthTitle;
                monthHeader.style.marginTop = '20px';
                approvedAbsencesCalendar.appendChild(monthHeader);

                const calendarGrid = document.createElement('div');
                calendarGrid.className = 'absence-calendar-grid';

                // Day headers
                dayNames.forEach(dayName => {
                    const headerCell = document.createElement('div');
                    headerCell.className = 'day-header';
                    headerCell.textContent = dayName;
                    calendarGrid.appendChild(headerCell);
                });

                // Empty cells for days before the 1st
                for (let i = 0; i < firstDayOfWeek; i++) {
                    calendarGrid.appendChild(document.createElement('div'));
                }

                for (let day = 1; day <= numDays; day++) {
                    const cell = document.createElement('div');
                    const currentDate = new Date(currentYear, currentMonth + monthOffset, day);
                    const formattedDate = currentDate.toISOString().split('T')[0]; //YYYY-MM-DD

                    cell.innerHTML = `<span class="day-number">${day}</span>`;
                    if (currentDate.toDateString() === today.toDateString()) {
                        cell.classList.add('today');
                    }

                    // Check for business-wide closures
                    const isBusinessClosed = currentBusinessData.unavailableDates.some(range => {
                        const start = new Date(range.startDate);
                        const end = new Date(range.endDate);
                        start.setHours(0,0,0,0); end.setHours(0,0,0,0);
                        return currentDate >= start && currentDate <= end;
                    });
                    if (isBusinessClosed) {
                        cell.classList.add('has-absence');
                        cell.title = "העסק סגור";
                    }

                    // Check for approved employee full-day absences (if stored this way)
                    // This logic would need to align with how you store approved absences:
                    // Option A: If you update employee's workHours to 'not working' (as in `approveAbsenceRequest` code example)
                    //    Then you'd need to fetch actual employee availability for this date. Complex for a simple calendar display.
                    // Option B: Store approved absences in a separate 'approved_absences' collection or as a specific field
                    //    in the employee's main document that is easy to query/iterate.
                    // For simplicity, for now, this calendar mainly shows business-wide closures.
                    // To show *employee* absences: you'd need to query `absence_requests` where status is 'approved'
                    // and then iterate over them to mark the calendar.
                    const employeeAbsencesForDay = (currentBusinessData.unavailableHours || []).filter(uh => uh.date === formattedDate && uh.type === 'employee_absence_hours');
                    if(employeeAbsencesForDay.length > 0) {
                        if(!cell.classList.contains('has-absence')) { // Don't override business closure
                            cell.classList.add('has-absence');
                        }
                        const employeeNames = employeeAbsencesForDay.map(abs => {
                            const employee = currentBusinessData.teamMembers.find(tm => tm.id === abs.employeeId);
                            return employee ? employee.name : 'עובד';
                        }).join(', ');
                        cell.innerHTML += `<br><small>${employeeNames}</small>`;
                        cell.title += ` ${employeeNames} בחופשה`;
                    }

                    calendarGrid.appendChild(cell);
                }
                approvedAbsencesCalendar.appendChild(calendarGrid);
            }
        }


        // --- Statistics Section Logic (Requires Chart.js) ---
        generateStatsBtn.addEventListener('click', async () => {
            if (!currentBusinessId) return;

            const startDate = statsStartDate.value;
            const endDate = statsEndDate.value;

            if (!startDate || !endDate) {
                alert("אנא בחר תאריכי התחלה וסיום לדוח.");
                return;
            }
            if (new Date(startDate) > new Date(endDate)) {
                alert("תאריך התחלה חייב להיות לפני או זהה לתאריך סיום.");
                return;
            }

            // Fetch all relevant appointments within the date range
            const q = db.collection("appointments")
                .where("businessId", "==", currentBusinessId)
                .where("date", ">=", startDate)
                .where("date", "<=", endDate);
            
            const querySnapshot = await q.get();
            const allAppointmentsInRange = querySnapshot.docs.map(doc => doc.data());

            // Fetch all reviews within the date range
            const reviewsQuery = db.collection("reviews")
                .where("businessId", "==", currentBusinessId)
                .where("createdAt", ">=", new Date(startDate).toISOString()) // Assuming createdAt is ISO string
                .where("createdAt", "<=", new Date(endDate).toISOString());
            
            const reviewsSnapshot = await reviewsQuery.get();
            const allReviewsInRange = reviewsSnapshot.docs.map(doc => doc.data());

            // 1. Revenue
            let totalRevenue = 0;
            const dailyRevenueMap = new Map();
            allAppointmentsInRange.filter(appt => appt.status === 'completed').forEach(appt => {
                const service = currentBusinessData.services.find(s => s.id === appt.serviceId);
                const price = service ? parseFloat(service.price || 0) : 0;
                totalRevenue += price;
                if (!dailyRevenueMap.has(appt.date)) {
                    dailyRevenueMap.set(appt.date, 0);
                }
                dailyRevenueMap.set(appt.date, dailyRevenueMap.get(appt.date) + price);
            });
            totalRevenueDisplay.textContent = `סה"כ הכנסות בטווח הנבחר: ${totalRevenue.toFixed(2)} ₪`;

            // Sort dates for chart
            const sortedDates = Array.from(dailyRevenueMap.keys()).sort();
            const dailyRevenueData = sortedDates.map(date => dailyRevenueMap.get(date));

            if (revenueChartInstance) revenueChartInstance.destroy();
            revenueChartInstance = new Chart(revenueChart, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'הכנסות יומיות',
                        data: dailyRevenueData,
                        borderColor: varColor('--primary-dark'),
                        backgroundColor: 'rgba(87, 36, 144, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'הכנסות לפי יום', font: { size: 16 } }
                    }
                }
            });

            // 2. Employee Occupancy
            const employeeAppointmentCounts = new Map();
            const totalWorkingTime = new Map(); // Assuming 8 hours/day for simplicity if not dynamically calculated
            const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];

            currentBusinessData.teamMembers.forEach(member => {
                employeeAppointmentCounts.set(member.name, 0);
                // Calculate total potential working hours within date range
                let memberTotalWorkMinutes = 0;
                let currentDate = new Date(startDate);
                const endDt = new Date(endDate);
                while (currentDate <= endDt) {
                    const dayOfWeek = dayNames[currentDate.getDay()];
                    let open = currentBusinessData.openTime;
                    let close = currentBusinessData.closeTime;
                    let isWorking = currentBusinessData.workDays.includes(dayOfWeek);

                    const employeeSpecificHours = member.workHours && member.workHours[dayOfWeek];
                    if (employeeSpecificHours) {
                        isWorking = employeeSpecificHours.isWorking;
                        open = employeeSpecificHours.openTime;
                        close = employeeSpecificHours.closeTime;
                    }

                    if (isWorking && open && close) {
                        const openMins = parseInt(open.split(':')[0]) * 60 + parseInt(open.split(':')[1]);
                        const closeMins = parseInt(close.split(':')[0]) * 60 + parseInt(close.split(':')[1]);
                        memberTotalWorkMinutes += (closeMins - openMins);
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                totalWorkingTime.set(member.name, memberTotalWorkMinutes);
            });

            allAppointmentsInRange.forEach(appt => {
                if (employeeAppointmentCounts.has(appt.teamMemberName)) {
                    employeeAppointmentCounts.set(appt.teamMemberName, employeeAppointmentCounts.get(appt.teamMemberName) + 1);
                }
            });

            const employeeNames = Array.from(employeeAppointmentCounts.keys());
            const appointmentCounts = Array.from(employeeAppointmentCounts.values());
            const occupancyPercentages = employeeNames.map(name => {
                const totalMinutes = totalWorkingTime.get(name);
                const totalApptMinutes = appointmentCounts[employeeNames.indexOf(name)] * (currentBusinessData.appointmentDuration + currentBusinessData.breakBetweenAppointments);
                return totalMinutes > 0 ? (totalApptMinutes / totalMinutes * 100).toFixed(2) : 0;
            });

            if (employeeOccupancyChartInstance) employeeOccupancyChartInstance.destroy();
            employeeOccupancyChartInstance = new Chart(employeeOccupancyChart, {
                type: 'bar',
                data: {
                    labels: employeeNames,
                    datasets: [{
                        label: 'אחוז תפוסה (%)',
                        data: occupancyPercentages,
                        backgroundColor: varColor('--secondary-light'),
                        borderColor: varColor('--secondary-light'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'תפוסת עובדים', font: { size: 16 } }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100, title: { display: true, text: 'אחוז תפוסה' } }
                    }
                }
            });


            // 3. Popular Services
            const serviceCounts = new Map();
            allAppointmentsInRange.forEach(appt => {
                if (!serviceCounts.has(appt.serviceName)) {
                    serviceCounts.set(appt.serviceName, 0);
                }
                serviceCounts.set(appt.serviceName, serviceCounts.get(appt.serviceName) + 1);
            });

            const serviceNames = Array.from(serviceCounts.keys());
            const serviceData = Array.from(serviceCounts.values());

            if (popularServicesChartInstance) popularServicesChartInstance.destroy();
            popularServicesChartInstance = new Chart(popularServicesChart, {
                type: 'pie',
                data: {
                    labels: serviceNames,
                    datasets: [{
                        label: 'מספר הזמנות',
                        data: serviceData,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C8', '#9966FF', '#FF9900' // Example colors
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'שירותים פופולריים', font: { size: 16 } },
                        legend: { position: 'right' }
                    }
                }
            });

            // 4. Peak Hours
            const peakHours = new Map(); // Hour of day (0-23)
            allAppointmentsInRange.forEach(appt => {
                const hour = parseInt(appt.time.split(':')[0]);
                if (!peakHours.has(hour)) {
                    peakHours.set(hour, 0);
                }
                peakHours.set(hour, peakHours.get(hour) + 1);
            });

            const sortedHours = Array.from(peakHours.keys()).sort((a, b) => a - b);
            const peakHourData = sortedHours.map(hour => peakHours.get(hour));
            const hourLabels = sortedHours.map(h => `${h}:00`);

            if (peakHoursChartInstance) peakHoursChartInstance.destroy();
            peakHoursChartInstance = new Chart(peakHoursChart, {
                type: 'bar',
                data: {
                    labels: hourLabels,
                    datasets: [{
                        label: 'מספר תורים',
                        data: peakHourData,
                        backgroundColor: varColor('--info-color'),
                        borderColor: varColor('--info-color'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'שעות שיא בקביעת תורים', font: { size: 16 } }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'מספר תורים' } },
                        x: { title: { display: true, text: 'שעה ביום' } }
                    }
                }
            });

            // 5. Reviews Summary
            const ratingCounts = new Map([
                [1, 0], [2, 0], [3, 0], [4, 0], [5, 0]
            ]);
            allReviewsInRange.forEach(review => {
                const rating = review.rating;
                if (ratingCounts.has(rating)) {
                    ratingCounts.set(rating, ratingCounts.get(rating) + 1);
                }
            });

            const reviewLabels = Array.from(ratingCounts.keys()).sort();
            const reviewData = reviewLabels.map(key => ratingCounts.get(key));

            if (reviewsSummaryChartInstance) reviewsSummaryChartInstance.destroy();
            reviewsSummaryChartInstance = new Chart(reviewsSummaryChart, {
                type: 'bar',
                data: {
                    labels: reviewLabels.map(r => `${r} כוכבים`),
                    datasets: [{
                        label: 'מספר ביקורות',
                        data: reviewData,
                        backgroundColor: ['#f87979', '#f8d279', '#d2f879', '#79f8d2', '#79a2f8'],
                        borderColor: ['#f87979', '#f8d279', '#d2f879', '#79f8d2', '#79a2f8'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'סיכום ביקורות', font: { size: 16 } }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'מספר ביקורות' } }
                    }
                }
            });
        });

        // Helper to get CSS variable color
        function varColor(variableName) {
            return getComputedStyle(document.documentElement).getPropertyValue(variableName).trim();
        }


        // --- Clock-in/Clock-out Section Logic (for current Employee/Manager) ---
        async function loadClockStatus() {
            if (!currentEmployeeData || !currentBusinessId) {
                clockStatus.textContent = 'אין נתוני עובד.';
                clockInBtn.style.display = 'none';
                clockOutBtn.style.display = 'none';
                return;
            }

            const today = new Date().toISOString().split('T')[0]; //YYYY-MM-DD
            const clockEntryRef = db.collection("business_clock_ins").doc(currentBusinessId).collection("employees").doc(currentEmployeeData.id);

            try {
                const docSnap = await clockEntryRef.get();
                let currentEntry = null;
                if (docSnap.exists && docSnap.data().entries) {
                    currentEntry = docSnap.data().entries.find(entry => entry.date === today && !entry.clockOutTime);
                }

                if (currentEntry) {
                    clockStatus.textContent = `מחובר (מאז ${currentEntry.clockInTime})`;
                    clockStatus.classList.remove('out');
                    clockStatus.classList.add('in');
                    clockInBtn.style.display = 'none';
                    clockOutBtn.style.display = 'block';
                    clockInTimeDisplay.style.display = 'block';
                    clockInTimeDisplay.textContent = `שעת כניסה: ${currentEntry.clockInTime}`;
                    clockOutTimeDisplay.style.display = 'none';

                    // Start a timer to update elapsed time (if needed, this example just shows the status)
                } else {
                    clockStatus.textContent = 'לא מחובר';
                    clockStatus.classList.remove('in');
                    clockStatus.classList.add('out');
                    clockInBtn.style.display = 'block';
                    clockOutBtn.style.display = 'none';
                    clockInTimeDisplay.style.display = 'none';
                    clockOutTimeDisplay.style.display = 'none';
                }
            } catch (error) {
                console.error("Error loading clock status:", error);
                clockStatus.textContent = 'שגיאה בטעינת סטטוס שעון.';
            }
        }

        clockInBtn.addEventListener('click', async () => {
            if (!currentEmployeeData || !currentBusinessId) return;

            const now = new Date();
            const currentTime = now.toTimeString().substring(0, 5); // HH:MM
            const today = now.toISOString().split('T')[0];

            // Basic check against business hours for today
            const dayOfWeek = new Date().toLocaleDateString('he-IL', { weekday: 'long' });
            let isWorkingHours = false;
            let effectiveOpen = currentBusinessData.openTime;
            let effectiveClose = currentBusinessData.closeTime;

            const employeeSpecificHours = currentEmployeeData.workHours && currentEmployeeData.workHours[dayOfWeek];
            if (employeeSpecificHours && employeeSpecificHours.isWorking) {
                isWorkingHours = true;
                effectiveOpen = employeeSpecificHours.openTime;
                effectiveClose = employeeSpecificHours.closeTime;
            } else if (currentBusinessData.workDays.includes(dayOfWeek)) {
                isWorkingHours = true;
            }

            if (!isWorkingHours || currentTime < effectiveOpen || currentTime > effectiveClose) {
                alert(`לא ניתן להיכנס מחוץ לשעות העבודה המוגדרות (${effectiveOpen}-${effectiveClose}).`);
                return;
            }

            try {
                const clockEntryRef = db.collection("business_clock_ins").doc(currentBusinessId).collection("employees").doc(currentEmployeeData.id);
                const docSnap = await clockEntryRef.get();
                let entries = [];
                if (docSnap.exists && docSnap.data().entries) {
                    entries = docSnap.data().entries;
                }
                entries.push({ date: today, clockInTime: currentTime, clockOutTime: null });

                await clockEntryRef.set({ entries: entries }, { merge: true });
                alert('נכנסת בהצלחה!');
                await loadClockStatus();
            } catch (error) {
                console.error("Error clocking in:", error);
                alert('שגיאה בכניסה: ' + (error.message || error));
            }
        });

        clockOutBtn.addEventListener('click', async () => {
            if (!currentEmployeeData || !currentBusinessId) return;

            const now = new Date();
            const currentTime = now.toTimeString().substring(0, 5); // HH:MM
            const today = now.toISOString().split('T')[0];

            try {
                const clockEntryRef = db.collection("business_clock_ins").doc(currentBusinessId).collection("employees").doc(currentEmployeeData.id);
                const docSnap = await clockEntryRef.get();
                let entries = docSnap.data().entries || [];

                const currentEntryIndex = entries.findIndex(entry => entry.date === today && !entry.clockOutTime);
                if (currentEntryIndex !== -1) {
                    entries[currentEntryIndex].clockOutTime = currentTime;
                    // Calculate total hours for the entry (simple, could be more robust)
                    const inTime = new Date(`2000-01-01T${entries[currentEntryIndex].clockInTime}`);
                    const outTime = new Date(`2000-01-01T${currentTime}`);
                    const durationMs = outTime - inTime;
                    entries[currentEntryIndex].durationMinutes = Math.round(durationMs / (1000 * 60));
                }

                await clockEntryRef.set({ entries: entries }, { merge: true });
                alert('יצאת בהצלחה!');
                await loadClockStatus();
                clockOutTimeDisplay.style.display = 'block';
                clockOutTimeDisplay.textContent = `שעת יציאה: ${currentTime}`;
            } catch (error) {
                console.error("Error clocking out:", error);
                alert('שגיאה ביציאה: ' + (error.message || error));
            }
        });

        async function loadEmployeeAppointmentsAndStatus() {
            if (!currentEmployeeData || !currentBusinessId) return;

            employeeClockName.textContent = currentEmployeeData.name || currentManagerUser.email;
            await loadClockStatus(); // Update clock-in/out display

            // Load next appointment
            nextAppointmentDisplay.innerHTML = '<p style="color:#888;">טוען את התור הבא...</p>';
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const tomorrow = new Date(now);
            tomorrow.setDate(now.getDate() + 1);
            const tomorrowFormatted = tomorrow.toISOString().split('T')[0];

            try {
                const qNext = db.collection("appointments")
                    .where("businessId", "==", currentBusinessId)
                    .where("teamMemberId", "==", currentEmployeeData.id)
                    .where("status", "==", "pending"); // Only show pending/future
                    // Add orderBy and limit to get nearest future appointment
                
                const nextAppointmentsSnapshot = await qNext.get();
                let upcomingAppts = [];
                nextAppointmentsSnapshot.forEach(docSnap => {
                    const appt = docSnap.data();
                    const apptDateTime = new Date(`${appt.date}T${appt.time}`);
                    if (apptDateTime >= now) {
                        upcomingAppts.push({ id: docSnap.id, ...appt });
                    }
                });

                upcomingAppts.sort((a, b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`));

                if (upcomingAppts.length > 0) {
                    const nextAppt = upcomingAppts[0];
                    nextAppointmentDisplay.innerHTML = `
                        <p><strong>לקוח:</strong> ${nextAppt.userName}</p>
                        <p><strong>שירות:</strong> ${nextAppt.serviceName}</p>
                        <p><strong>תאריך:</strong> ${nextAppt.date}</p>
                        <p><strong>שעה:</strong> ${nextAppt.time}</p>
                    `;
                } else {
                    nextAppointmentDisplay.innerHTML = '<p style="color:#888;">אין תור קרוב.</p>';
                }

                // Load all appointments for employee
                myAppointmentsEmployeeTable.innerHTML = '';
                noEmployeeAppointments.style.display = 'block';

                const qAll = db.collection("appointments")
                    .where("businessId", "==", currentBusinessId)
                    .where("teamMemberId", "==", currentEmployeeData.id);
                
                const allApptsSnapshot = await qAll.get();
                const allEmployeeAppts = allApptsSnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));

                if (allEmployeeAppts.length === 0) {
                    myAppointmentsEmployeeTable.innerHTML = '';
                    noEmployeeAppointments.style.display = 'block';
                    return;
                }

                noEmployeeAppointments.style.display = 'none';
                allEmployeeAppts.sort((a, b) => new Date(`${b.date}T${b.time}`) - new Date(`${a.date}T${a.time}`)); // Newest first

                allEmployeeAppts.forEach(appt => {
                    const row = myAppointmentsEmployeeTable.insertRow();
                    row.innerHTML = `
                        <td>${appt.date}</td>
                        <td>${appt.time}</td>
                        <td>${appt.userName}</td>
                        <td>${appt.serviceName}</td>
                        <td>${appt.status}</td>
                        <td class="actions">
                            <button class="primary employee-complete-appt" data-id="${appt.id}" ${appt.status === 'completed' ? 'disabled' : ''}>
                                ${appt.status === 'completed' ? 'הושלם' : 'סמן כהושלם'}
                            </button>
                            <button class="danger employee-cancel-appt" data-id="${appt.id}" ${appt.status === 'cancelled' ? 'disabled' : ''}>
                                ${appt.status === 'cancelled' ? 'בוטל' : 'בטל'}
                            </button>
                        </td>
                    `;
                    row.querySelector('.employee-complete-appt').addEventListener('click', () => updateAppointmentStatus(appt.id, 'completed'));
                    row.querySelector('.employee-cancel-appt').addEventListener('click', () => updateAppointmentStatus(appt.id, 'cancelled'));
                });


            } catch (error) {
                console.error("Error loading employee appointments:", error);
                nextAppointmentDisplay.innerHTML = '<p style="color:red;">שגיאה בטעינת תורים.</p>';
                myAppointmentsEmployeeTable.innerHTML = '<p style="color:red;">שגיאה בטעינת תורים.</p>';
            }

            loadEmployeeAbsenceRequestsEmployeeView();
        }

        // Employee absence request form
        document.querySelectorAll('input[name="absenceType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'specificHours') {
                    specificHoursFields.style.display = 'block';
                } else {
                    specificHoursFields.style.display = 'none';
                }
            });
        });

        requestAbsenceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentEmployeeData || !currentBusinessId) {
                alert("אין נתוני עובד כדי לשלוח בקשת חופשה.");
                return;
            }

            const absenceType = document.querySelector('input[name="absenceType"]:checked').value;
            const absenceDate = document.getElementById('absenceDate').value;
            const absenceStartTime = document.getElementById('absenceStartTime').value;
            const absenceEndTime = document.getElementById('absenceEndTime').value;

            if (!absenceDate) {
                alert("אנא בחר תאריך חופשה.");
                return;
            }
            if (absenceType === 'specificHours' && (!absenceStartTime || !absenceEndTime)) {
                alert("אנא בחר שעות התחלה וסיום עבור חופשה חלקית.");
                return;
            }
            if (absenceType === 'specificHours' && absenceStartTime >= absenceEndTime) {
                 alert("שעת התחלה חייבת להיות לפני שעת סיום.");
                 return;
             }

            try {
                await db.collection("absence_requests").add({
                    businessId: currentBusinessId,
                    employeeId: currentEmployeeData.id,
                    employeeName: currentEmployeeData.name,
                    date: absenceDate,
                    type: absenceType, // 'fullDay' or 'specificHours'
                    startTime: absenceType === 'specificHours' ? absenceStartTime : null,
                    endTime: absenceType === 'specificHours' ? absenceEndTime : null,
                    reason: "חופשה אישית", // Could add a reason input field
                    status: 'pending',
                    requestedAt: new Date().toISOString()
                });
                alert('בקשת חופשה נשלחה למנהל לאישור.');
                requestAbsenceForm.reset();
                specificHoursFields.style.display = 'none';
                await loadEmployeeAbsenceRequestsEmployeeView(); // Refresh list
            } catch (error) {
                console.error("Error submitting absence request:", error);
                alert('שגיאה בשליחת בקשת חופשה: ' + (error.message || error));
            }
        });

        async function loadEmployeeAbsenceRequestsEmployeeView() {
            pendingAbsenceRequests.innerHTML = '';
            noPendingAbsences.style.display = 'block';
            if (!currentEmployeeData || !currentBusinessId) return;

            try {
                const q = db.collection("absence_requests")
                    .where("businessId", "==", currentBusinessId)
                    .where("employeeId", "==", currentEmployeeData.id);
                
                const querySnapshot = await q.get();

                if (querySnapshot.empty) {
                    pendingAbsenceRequests.innerHTML = '';
                    noPendingAbsences.style.display = 'block';
                    return;
                }

                noPendingAbsences.style.display = 'none';
                querySnapshot.docs.sort((a, b) => new Date(b.data().requestedAt) - new Date(a.data().requestedAt)) // Newest first
                    .forEach(docSnap => {
                        const request = docSnap.data();
                        const div = document.createElement('div');
                        div.className = 'absence-entry';
                        let displayDates = `${request.date}`;
                        if (request.type === 'fullDay') {
                            displayDates = `יום שלם: ${request.date}`;
                        } else if (request.type === 'specificHours') {
                            displayDates = `שעות: ${request.date}, ${request.startTime}-${request.endTime}`;
                        }
                        div.innerHTML = `
                            <span>${displayDates} (סטטוס: ${request.status === 'pending' ? 'ממתין' : request.status === 'approved' ? 'אושר' : 'נדחה'})</span>
                        `;
                        pendingAbsenceRequests.appendChild(div);
                    });
            } catch (error) {
                console.error("Error loading employee's absence requests:", error);
                pendingAbsenceRequests.innerHTML = `<p style="text-align: center; color: red;">שגיאה בטעינת בקשות חופשה.</p>`;
            }
        }


        // Real-time updates (BLT"Ms) - these would require server-side logic
        // or direct DB updates that affect current business data and possibly calendar regeneration.
        longBreakBtn.addEventListener('click', () => {
            alert('הפסקה ארוכה סומנה. יש ליישם לוגיקה לחסימת תורים זמנית.');
            // Implement logic to temporarily block appointments for this employee
            // This would likely involve updating a field in employee's document or a real-time "status"
        });

        urgentExitBtn.addEventListener('click', async () => {
            if (confirm('האם אתה בטוח שברצונך לסמן יציאה דחופה? פעולה זו תבצע יציאה מהשעון ותחסום תורים באופן מיידי.')) {
                await clockOutBtn.click(); // Simulate clock out
                alert('יציאה דחופה סומנה. יש ליישם לוגיקה לחסימת תורים עד כניסה מחודשת.');
                // Implement logic to block future appointments for today/until next clock-in
            }
        });

        addWalkInAppointmentBtn.addEventListener('click', () => {
            alert('קבלת תור נוסף (Walk-in) סומנה. יש ליישם לוגיקה להוספת תור מהיר למערכת.');
            // This would open a simplified modal to quickly add an appointment for the current employee
            // and block the time slot.
        });


        // --- General Functions ---
        // Helper to refresh currentBusinessData from Firestore
        async function updateCurrentBusinessData() {
            if (currentBusinessId) {
                const businessDocRef = db.collection("businesses").doc(currentBusinessId);
                const businessDocSnap = await businessDocRef.get();
                if (businessDocSnap.exists) {
                    currentBusinessData = { id: businessDocSnap.id, ...businessDocSnap.data() };
                } else {
                    console.error("Business data not found after refresh.");
                    currentBusinessData = null;
                }
            }
        }

        // Initial loading of the app
        document.addEventListener('DOMContentLoaded', () => {
            showLoading(); // Show loading screen initially
        });

    </script>
</body>
</html>
